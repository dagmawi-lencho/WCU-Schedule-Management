<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wachemo University - Class Scheduling System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #B0E0E6 0%, #87CEEB 50%, #E0F6FF 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #8B0000 0%, #A52A2A 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(139, 0, 0, 0.3);
            animation: slideDown 0.5s ease;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }
        .logo {
            width: 70px;
            height: 70px;
            background: white;
            border-radius: 50%;
            padding: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 50%;
        }
        .header-title {
            flex: 1;
        }
        .header-title h1 {
            color: white;
            margin-bottom: 5px;
            font-size: 28px;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .header-title .subtitle {
            color: rgba(255,255,255,0.9);
            font-size: 14px;
            font-weight: 400;
        }
        .user-info {
            color: rgba(255,255,255,0.9);
            font-size: 14px;
        }
        .logout-btn {
            float: right;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: -45px;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab {
            background: white;
            padding: 15px 28px;
            border: none;
            border-radius: 10px 10px 0 0;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        .tab:hover::before {
            left: 100%;
        }
        .tab:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
        }
        .tab.active {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            color: #8B0000;
            border-bottom: 4px solid #8B0000;
            box-shadow: 0 -4px 15px rgba(139, 0, 0, 0.2);
        }
        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 0 15px 15px 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .tab-content.active {
            display: block;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #8B0000;
            box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.1);
        }
        button {
            background: linear-gradient(135deg, #8B0000 0%, #A52A2A 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(139, 0, 0, 0.4);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        button:active {
            transform: translateY(0);
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }
        .btn-danger:hover {
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.6);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            background: linear-gradient(135deg, #8B0000 0%, #A52A2A 100%);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }
        tr:hover {
            background: #f9fafb;
            transition: background 0.2s;
        }
        tr:last-child td {
            border-bottom: none;
        }
        .alert {
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .login-container h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border-top: 4px solid #8B0000;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(139, 0, 0, 0.2);
        }
        .stat-card h3 {
            color: #333;
            font-size: 14px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .stat-card .number {
            font-size: 42px;
            font-weight: 700;
            background: linear-gradient(135deg, #8B0000 0%, #A52A2A 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" style="min-height: 100vh; background: linear-gradient(135deg, #B0E0E6 0%, #87CEEB 50%, #E0F6FF 100%); display: flex; align-items: center; justify-content: center; padding: 20px;">
        <div style="background: white; border-radius: 25px; padding: 50px 40px; max-width: 480px; width: 100%; box-shadow: 0 25px 70px rgba(139, 0, 0, 0.2); border: 3px solid #8B0000;">
            <div style="text-align: center; margin-bottom: 35px;">
                <!-- University Logo -->
                <div style="width: 140px; height: 140px; margin: 0 auto 25px; background: linear-gradient(135deg, #B0E0E6 0%, #E0F6FF 100%); border-radius: 50%; padding: 8px; border: 4px solid #8B0000; box-shadow: 0 8px 25px rgba(139, 0, 0, 0.3); display: flex; align-items: center; justify-content: center;">
                    <img src="/logo.jpg" alt="Wachemo University Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 50%;" />
                </div>
                <h1 style="margin: 0; color: #8B0000; font-size: 32px; font-weight: 700; text-shadow: 0 2px 4px rgba(139, 0, 0, 0.1);">·ãã·â∏·àû ·ã©·äí·â®·à≠·à≤·â≤</h1>
                <h2 style="margin: 8px 0 0; color: #8B0000; font-size: 24px; font-weight: 600;">Wachemo University</h2>
                <p style="margin: 12px 0 0; color: #666; font-size: 15px; font-weight: 500;">Class Scheduling System</p>
            </div>
            
            <div id="loginAlert" style="margin-bottom: 20px;"></div>
            
            <form id="loginForm" style="display: flex; flex-direction: column; gap: 22px;">
                <div>
                    <label style="display: block; margin-bottom: 10px; color: #8B0000; font-weight: 600; font-size: 14px;">üìß Email Address</label>
                    <input type="email" id="loginEmail" required style="width: 100%; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; transition: all 0.3s; box-sizing: border-box;" placeholder="admin@wachemo.edu" onfocus="this.style.borderColor='#8B0000'; this.style.boxShadow='0 0 0 3px rgba(139, 0, 0, 0.1)'" onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'">
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 10px; color: #8B0000; font-weight: 600; font-size: 14px;">üîí Password</label>
                    <input type="password" id="loginPassword" required style="width: 100%; padding: 14px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 15px; transition: all 0.3s; box-sizing: border-box;" placeholder="Enter your password" onfocus="this.style.borderColor='#8B0000'; this.style.boxShadow='0 0 0 3px rgba(139, 0, 0, 0.1)'" onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'">
                </div>
                
                <button type="submit" style="background: linear-gradient(135deg, #8B0000 0%, #A52A2A 100%); color: white; border: none; padding: 16px; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.3s; box-shadow: 0 6px 20px rgba(139, 0, 0, 0.4); text-transform: uppercase; letter-spacing: 0.5px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(139, 0, 0, 0.6)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 20px rgba(139, 0, 0, 0.4)'">
                    üîê Login
                </button>
            </form>
            
            <div style="margin-top: 25px; padding-top: 25px; border-top: 2px solid #e5e7eb; text-align: center;">
                <p style="margin: 0; color: #666; font-size: 12px; line-height: 1.6;">
                    <strong style="color: #8B0000;">Default Admin Credentials:</strong><br>
                    Email: <strong>admin@wachemo.edu</strong><br>
                    Password: <strong>Admin@2024</strong>
                </p>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" style="display:none;">
        <div class="container">
            <div class="header">
                <div class="logo-container">
                    <div class="logo">
                        <img src="/logo.jpg" alt="Wachemo University Logo" />
                    </div>
                    <div class="header-title">
                        <h1>Wachemo University</h1>
                        <div class="subtitle">Class Scheduling System - Admin Panel</div>
                    </div>
                </div>
                <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 8px;">
                    <button class="logout-btn" onclick="location.reload()" style="margin: 0; padding: 8px 16px; font-size: 13px;">üîÑ Refresh</button>
                    <button class="logout-btn" onclick="logout()" style="margin: 0; padding: 8px 16px; font-size: 13px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">üö™ Logout</button>
                    <div class="user-info" style="font-size: 12px;">
                        <span id="currentUserEmail">Admin</span> | <span id="currentUserRoleDisplay">Administrator</span>
                    </div>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showTab('dashboard')">Dashboard</button>
                <button class="tab" onclick="showTab('users')" id="usersTab" style="display: none;">üë• Users</button>
                <button class="tab" onclick="showTab('departments')">Departments</button>
                <button class="tab" onclick="showTab('batches')">Batches</button>
                <button class="tab" onclick="showTab('semesters')">Semesters</button>
                <button class="tab" onclick="showTab('courses')">Courses</button>
                <button class="tab" onclick="showTab('instructors')">Instructors</button>
                <button class="tab" onclick="showTab('rooms')">Rooms</button>
                <button class="tab" onclick="showTab('classRepresentatives')">Class Representatives</button>
                <button class="tab" onclick="showTab('schedules')">Schedules</button>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h2 style="margin: 0; color: #333; font-size: 32px; font-weight: 700;">üìä Dashboard Overview</h2>
                    <div style="background: linear-gradient(135deg, #228B22 0%, #32CD32 100%); color: white; padding: 12px 24px; border-radius: 25px; font-weight: 600; box-shadow: 0 4px 15px rgba(34, 139, 34, 0.4);">
                        System Status: Active ‚úÖ
                    </div>
                </div>
                <div class="stats" id="stats">
                    <div class="stat-card" style="border-top-color: #8B0000;">
                        <div style="font-size: 32px; margin-bottom: 10px;">üéì</div>
                        <h3>Batches</h3>
                        <div class="number" id="statBatches">0</div>
                    </div>
                    <div class="stat-card" style="border-top-color: #228B22;">
                        <div style="font-size: 32px; margin-bottom: 10px;">üìö</div>
                        <h3>Courses</h3>
                        <div class="number" id="statCourses">0</div>
                    </div>
                    <div class="stat-card" style="border-top-color: #FFA500;">
                        <div style="font-size: 32px; margin-bottom: 10px;">üë®‚Äçüè´</div>
                        <h3>Instructors</h3>
                        <div class="number" id="statInstructors">0</div>
                    </div>
                    <div class="stat-card" style="border-top-color: #4169E1;">
                        <div style="font-size: 32px; margin-bottom: 10px;">üìÖ</div>
                        <h3>Schedules</h3>
                        <div class="number" id="statSchedules">0</div>
                    </div>
                </div>
                <div style="background: linear-gradient(135deg, #E0F6FF 0%, #B0E0E6 100%); padding: 25px; border-radius: 15px; margin-top: 30px; border-left: 5px solid #8B0000;">
                    <h3 style="margin-top: 0; color: #8B0000; font-weight: 700;">üöÄ Quick Actions</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                        <button onclick="showTab('batches')" style="background: linear-gradient(135deg, #8B0000 0%, #A52A2A 100%);">‚ûï Create Batch</button>
                        <button onclick="showTab('courses')" style="background: linear-gradient(135deg, #228B22 0%, #32CD32 100%);">üìù Register Course</button>
                        <button onclick="showTab('instructors')" style="background: linear-gradient(135deg, #FFA500 0%, #FFD700 100%);">üë®‚Äçüè´ Add Instructor</button>
                        <button onclick="showTab('schedules')" style="background: linear-gradient(135deg, #4169E1 0%, #87CEEB 100%);">üìÖ Generate Schedule</button>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="users" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h2 style="margin: 0; color: #333; font-size: 32px; font-weight: 700;">üë• User Management</h2>
                </div>
                <div id="userAlert"></div>
                <form id="userForm" style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <input type="hidden" id="userEditId" value="">
                    <div class="form-group">
                        <label>Full Name *</label>
                        <input type="text" id="userFullName" required placeholder="e.g., John Doe">
                    </div>
                    <div class="form-group">
                        <label>Email Address *</label>
                        <input type="email" id="userEmailInput" required placeholder="e.g., user@university.edu">
                    </div>
                    <div class="form-group">
                        <label id="userPasswordLabel">Password *</label>
                        <input type="password" id="userPassword" required placeholder="Minimum 6 characters">
                    </div>
                    <div class="form-group">
                        <label>Role *</label>
                        <select id="userRole" required>
                            <option value="">Select Role</option>
                            <option value="admin">Admin - Full system access</option>
                            <option value="instructor">Instructor - Can view schedules and courses</option>
                            <option value="department_head">Department Head - Can manage department data</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" id="userPhoneNumber" placeholder="e.g., +251900000000">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" id="userSubmitBtn" style="background: linear-gradient(135deg, #8B0000 0%, #A52A2A 100%);">Create User</button>
                        <button type="button" id="userCancelBtn" onclick="cancelUserEdit()" style="display: none; background: #6b7280;">Cancel</button>
                    </div>
                </form>
                <table id="usersTable" style="width: 100%; border-collapse: collapse; background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #8B0000 0%, #A52A2A 100%); color: white;">
                            <th style="padding: 15px; text-align: left; font-weight: 600;">Full Name</th>
                            <th style="padding: 15px; text-align: left; font-weight: 600;">Email</th>
                            <th style="padding: 15px; text-align: left; font-weight: 600;">Role</th>
                            <th style="padding: 15px; text-align: left; font-weight: 600;">Phone Number</th>
                            <th style="padding: 15px; text-align: left; font-weight: 600;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px; color: #999;">Loading users...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Departments Tab -->
            <div id="departments" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h2 style="margin: 0; color: #333; font-size: 32px; font-weight: 700;">üìö Departments</h2>
                </div>
                <div id="departmentAlert"></div>
                <form id="departmentForm" style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <input type="hidden" id="departmentEditId" value="">
                    <div class="form-group">
                        <label>Department Name *</label>
                        <input type="text" id="departmentName" required placeholder="e.g., Software Engineering">
                    </div>
                    <div class="form-group">
                        <label>Short Name / Code *</label>
                        <input type="text" id="departmentCode" required placeholder="e.g., SE" maxlength="10" style="text-transform: uppercase;">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" id="departmentSubmitBtn" style="background: linear-gradient(135deg, #8B0000 0%, #A52A2A 100%);">Create Department</button>
                        <button type="button" id="departmentCancelBtn" onclick="cancelDepartmentEdit()" style="display: none; background: #6b7280;">Cancel</button>
                    </div>
                </form>
                <table id="departmentsTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Code</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Batches Tab -->
            <div id="batches" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h2 style="margin: 0; color: #333; font-size: 32px; font-weight: 700;">üìä Batches</h2>
                </div>
                <div id="batchAlert"></div>
                <form id="batchForm" style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <input type="hidden" id="batchEditId" value="">
                    <div class="form-group">
                        <label>Batch Number</label>
                        <input type="text" id="batchNumber" required placeholder="e.g., 2018">
                    </div>
                    <div class="form-group">
                        <label>Number of Years</label>
                        <input type="number" id="numberOfYears" required min="1" max="10" value="4">
                    </div>
                    <div class="form-group">
                        <label>Sections (comma-separated)</label>
                        <input type="text" id="sections" placeholder="A, B, C" value="A">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" id="batchSubmitBtn" style="background: linear-gradient(135deg, #8B0000 0%, #A52A2A 100%);">Create Batch</button>
                        <button type="button" id="batchCancelBtn" onclick="cancelBatchEdit()" style="display: none; background: #6b7280;">Cancel</button>
                    </div>
                </form>
                <table id="batchesTable">
                    <thead>
                        <tr>
                            <th>Batch Number</th>
                            <th>Years</th>
                            <th>Sections</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Semesters Tab -->
            <div id="semesters" class="tab-content">
                <h2>Semesters</h2>
                <div id="semesterAlert"></div>
                <form id="semesterForm">
                    <input type="hidden" id="semesterEditId" value="">
                    <div class="form-group">
                        <label>Batch</label>
                        <select id="semesterBatchId" required></select>
                    </div>
                    <div class="form-group">
                        <label>Semester Number</label>
                        <input type="number" id="semesterNumber" required min="1">
                    </div>
                    <div class="form-group">
                        <label>Semester Name</label>
                        <input type="text" id="semesterName" required placeholder="e.g., Semester 1">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" id="semesterSubmitBtn">Create Semester</button>
                        <button type="button" id="semesterCancelBtn" onclick="cancelSemesterEdit()" style="display: none; background: #6b7280;">Cancel</button>
                    </div>
                </form>
                <table id="semestersTable">
                    <thead>
                        <tr>
                            <th>Batch</th>
                            <th>Semester Number</th>
                            <th>Name</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Courses Tab -->
            <div id="courses" class="tab-content">
                <h2>Courses</h2>
                <div id="courseAlert"></div>
                <form id="courseForm">
                    <input type="hidden" id="courseEditId" value="">
                    <div class="form-group">
                        <label>Course Name</label>
                        <input type="text" id="courseName" required>
                    </div>
                    <div class="form-group">
                        <label>Course Code</label>
                        <input type="text" id="courseCode" required>
                    </div>
                    <div class="form-group">
                        <label>Credit Hour</label>
                        <input type="number" id="creditHour" required min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="majorOrCommon" required>
                            <option value="major">Major</option>
                            <option value="common">Common</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Batch</label>
                        <select id="courseBatchId" required></select>
                    </div>
                    <div class="form-group">
                        <label>Semester</label>
                        <select id="courseSemesterId" required></select>
                    </div>
                    <div class="form-group">
                        <label>Instructor</label>
                        <select id="instructorId" required></select>
                    </div>
                    <div class="form-group">
                        <label>Department (optional)</label>
                        <select id="courseDepartment" style="padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                            <option value="">Select Department (Optional)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="hasLab"> Has Lab</label>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" id="courseSubmitBtn">Create Course</button>
                        <button type="button" id="courseCancelBtn" onclick="cancelCourseEdit()" style="display: none; background: #6b7280;">Cancel</button>
                    </div>
                </form>
                <table id="coursesTable">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Name</th>
                            <th>Credits</th>
                            <th>Type</th>
                            <th>Has Lab</th>
                            <th>Instructor</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Instructors Tab -->
            <div id="instructors" class="tab-content">
                <h2>Instructors</h2>
                <div id="instructorAlert"></div>
                <form id="instructorForm">
                    <input type="hidden" id="instructorEditId" value="">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="instructorFullName" required>
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="text" id="instructorPhone" required>
                    </div>
                    <div class="form-group">
                        <label>ID Number</label>
                        <input type="text" id="idNumber" required>
                    </div>
                    <div class="form-group">
                        <label>Profession</label>
                        <input type="text" id="profession" required placeholder="e.g., MSc in Software Engineering">
                    </div>
                    <div class="form-group">
                        <label>Position</label>
                        <input type="text" id="position" required placeholder="e.g., Lecturer">
                    </div>
                    <div class="form-group">
                        <label>Max Teaching Load (credits)</label>
                        <input type="number" id="maxTeachingLoad" required value="12">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" id="instructorSubmitBtn">Create Instructor</button>
                        <button type="button" id="instructorCancelBtn" onclick="cancelInstructorEdit()" style="display: none; background: #6b7280;">Cancel</button>
                    </div>
                </form>
                <table id="instructorsTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>ID Number</th>
                            <th>Position</th>
                            <th>Profession</th>
                            <th>Max Load</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Schedules Tab -->
            <div id="schedules" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h2 style="margin: 0; color: #333; font-size: 28px;">üìÖ Schedule Generation</h2>
                    <div style="background: linear-gradient(135deg, #8B0000 0%, #A52A2A 100%); color: white; padding: 10px 20px; border-radius: 25px; font-weight: 600;">
                        Auto Schedule Generator
                    </div>
                </div>
                
                <div id="scheduleAlert"></div>
                
                <div style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 30px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 8px 25px rgba(0,0,0,0.1);">
                    <h3 style="margin-top: 0; color: #333; margin-bottom: 20px; font-size: 20px;">‚öôÔ∏è Generation Settings</h3>
                    <form id="scheduleForm" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div class="form-group">
                            <label style="font-weight: 600; color: #555; margin-bottom: 8px; display: block;">üéì Batch</label>
                            <select id="scheduleBatchId" required style="padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; transition: all 0.3s;"></select>
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; color: #555; margin-bottom: 8px; display: block;">üìö Semester</label>
                            <select id="scheduleSemesterId" required style="padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; transition: all 0.3s;"></select>
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; color: #555; margin-bottom: 8px; display: block;">üë• Section</label>
                            <select id="scheduleSection" required style="padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; transition: all 0.3s;">
                                <option value="">Select Section</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; color: #555; margin-bottom: 8px; display: block;">üèõÔ∏è Department (optional)</label>
                            <select id="scheduleDepartment" style="padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; transition: all 0.3s;">
                                <option value="">Select Department (Optional)</option>
                            </select>
                        </div>
                    </form>
                    
                    <!-- Pre-Criteria Section -->
                    <div style="margin-top: 25px; padding: 20px; background: white; border-radius: 10px; border: 2px solid #8B0000;">
                        <h4 style="margin-top: 0; color: #8B0000; font-size: 16px; margin-bottom: 15px;">‚öôÔ∏è Pre-Criteria Settings</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div class="form-group">
                                <label style="font-weight: 600; color: #555; margin-bottom: 8px; display: block;">Major Courses ‚Üí</label>
                                <select id="majorCoursesShift" style="padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                                    <option value="morning">Morning</option>
                                    <option value="afternoon">Afternoon</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label style="font-weight: 600; color: #555; margin-bottom: 8px; display: block;">Common Courses ‚Üí</label>
                                <select id="commonCoursesShift" style="padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                                    <option value="afternoon">Afternoon</option>
                                    <option value="morning">Morning</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Room Selection Section -->
                    <div style="margin-top: 20px; padding: 20px; background: white; border-radius: 10px; border: 2px solid #228B22;">
                        <h4 style="margin-top: 0; color: #228B22; font-size: 16px; margin-bottom: 15px;">üè´ Room Selection</h4>
                        <p style="color: #666; font-size: 13px; margin-bottom: 15px;">Select available rooms/labs to use for schedule generation (leave empty to use all available rooms)</p>
                        <div id="roomSelection" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; max-height: 200px; overflow-y: auto; padding: 10px; background: #f9f9f9; border-radius: 8px;"></div>
                    </div>

                    <div style="display: flex; gap: 15px; margin-top: 25px;">
                        <button type="submit" form="scheduleForm" id="scheduleSubmitBtn" style="flex: 1; padding: 15px; font-size: 16px; background: linear-gradient(135deg, #8B0000 0%, #A52A2A 100%);">
                            üöÄ Generate Schedule Automatically
                        </button>
                        <button type="button" id="generateAllBatchesBtn" style="flex: 1; padding: 15px; font-size: 16px; background: linear-gradient(135deg, #228B22 0%, #32CD32 100%);">
                            üåê Generate All Batches
                        </button>
                    </div>
                </div>

                <div id="schedulePreview" style="display: none; background: white; padding: 25px; border-radius: 15px; margin-bottom: 30px; border: 3px solid #8B0000; box-shadow: 0 10px 30px rgba(139, 0, 0, 0.2);">
                    <h3 style="margin-top: 0; color: #8B0000;">‚ú® Generated Schedule Preview</h3>
                    <div id="previewContent"></div>
                </div>

                <div>
                    <h3 style="color: #333; margin-bottom: 20px; font-size: 22px;">üìã All Generated Schedules</h3>
                    <div id="schedulesList" style="display: grid; gap: 20px;"></div>
                </div>
            </div>

            <!-- Class Representatives Tab -->
            <div id="classRepresentatives" class="tab-content">
                <h2>Class Representatives</h2>
                <div id="classRepAlert"></div>
                <form id="classRepForm">
                    <input type="hidden" id="classRepEditId" value="">
                    <div class="form-group">
                        <label>Batch</label>
                        <select id="classRepBatchId" required></select>
                    </div>
                    <div class="form-group">
                        <label>Section</label>
                        <select id="classRepSection" required></select>
                    </div>
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="classRepFullName" required placeholder="e.g., John Doe">
                    </div>
                    <div class="form-group">
                        <label>ID Number</label>
                        <input type="text" id="classRepIdNumber" required placeholder="e.g., STU001">
                    </div>
                    <div class="form-group">
                        <label>Phone Number (optional)</label>
                        <input type="text" id="classRepPhone" placeholder="e.g., +251900000000">
                    </div>
                    <div class="form-group">
                        <label>Email (optional)</label>
                        <input type="email" id="classRepEmail" placeholder="e.g., john@example.com">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" id="classRepSubmitBtn">Create Class Representative</button>
                        <button type="button" id="classRepCancelBtn" onclick="cancelClassRepEdit()" style="display: none; background: #6b7280;">Cancel</button>
                    </div>
                </form>
                <table id="classRepTable">
                    <thead>
                        <tr>
                            <th>Batch</th>
                            <th>Section</th>
                            <th>Full Name</th>
                            <th>ID Number</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Rooms Tab -->
            <div id="rooms" class="tab-content">
                <h2>Rooms</h2>
                <div id="roomAlert"></div>
                <form id="roomForm">
                    <input type="hidden" id="roomEditId" value="">
                    <div class="form-group">
                        <label>Room Number</label>
                        <input type="text" id="roomNumber" required placeholder="e.g., Lab1, CR1">
                    </div>
                    <div class="form-group">
                        <label>Room Type</label>
                        <select id="roomType" required>
                            <option value="">Select Type</option>
                            <option value="lab">Lab</option>
                            <option value="classroom">Classroom</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Capacity</label>
                        <input type="number" id="roomCapacity" required min="1" placeholder="e.g., 30, 50">
                    </div>
                    <div class="form-group">
                        <label>Facilities (comma-separated, optional)</label>
                        <input type="text" id="roomFacilities" placeholder="e.g., Projector, Whiteboard, AC">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="roomIsAvailable" checked> Available
                        </label>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" id="roomSubmitBtn">Create Room</button>
                        <button type="button" id="roomCancelBtn" onclick="cancelRoomEdit()" style="display: none; background: #6b7280;">Cancel</button>
                        <button type="button" onclick="initializeRooms()" style="background: linear-gradient(135deg, #8B0000 0%, #A52A2A 100%);">Initialize Default Rooms</button>
                    </div>
                </form>
                <table id="roomsTable">
                    <thead>
                        <tr>
                            <th>Room Number</th>
                            <th>Type</th>
                            <th>Capacity</th>
                            <th>Facilities</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ========== AUTHENTICATION & API CONFIGURATION ==========
        const API_BASE = 'http://localhost:5000/api';
        let authToken = localStorage.getItem('authToken') || null;
        let currentUser = null;
        
        // Load current user from localStorage
        try {
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser && storedUser !== 'null') {
                currentUser = JSON.parse(storedUser);
            }
        } catch (e) {
            console.error('Error loading user from localStorage:', e);
        }
        
        // Check if user is logged in
        function checkAuth() {
            if (!authToken || !currentUser) {
                showLoginPage();
                return false;
            }
            return true;
        }
        
        // Show login page
        function showLoginPage() {
            const loginPage = document.getElementById('loginPage');
            const adminPanel = document.getElementById('adminPanel');
            if (loginPage) loginPage.style.display = 'flex';
            if (adminPanel) adminPanel.style.display = 'none';
            console.log('Login page shown');
        }
        
        // Show admin panel
        function showAdminPanel() {
            const loginPage = document.getElementById('loginPage');
            const adminPanel = document.getElementById('adminPanel');
            if (loginPage) loginPage.style.display = 'none';
            if (adminPanel) adminPanel.style.display = 'block';
            
            if (currentUser) {
                const userEmailEl = document.getElementById('currentUserEmail');
                const userRoleEl = document.getElementById('currentUserRoleDisplay');
                if (userEmailEl) userEmailEl.textContent = currentUser.email || 'Admin';
                if (userRoleEl) userRoleEl.textContent = currentUser.role || 'Administrator';
            }
            console.log('Admin panel shown');
        }
        
        // Logout function
        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            showLoginPage();
        }
        
        window.logout = logout;
        
        // Login Form Handler - Wait for DOM to be ready
        function attachLoginHandler() {
            const loginForm = document.getElementById('loginForm');
            if (!loginForm) {
                console.error('Login form not found!');
                return;
            }
            
            // Remove existing listener if any
            const newForm = loginForm.cloneNode(true);
            loginForm.parentNode.replaceChild(newForm, loginForm);
            
            newForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginBtn = e.target.querySelector('button[type="submit"]');
            const originalText = loginBtn.innerHTML;
            
            loginBtn.innerHTML = '‚è≥ Logging in...';
            loginBtn.disabled = true;
            
            try {
                console.log('Attempting login to:', `${API_BASE}/auth/login`);
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                console.log('Response status:', response.status);
                
                let data;
                try {
                    data = await response.json();
                    console.log('Response data:', data);
                } catch (jsonError) {
                    console.error('Failed to parse JSON response:', jsonError);
                    const text = await response.text();
                    console.error('Response text:', text);
                    throw new Error('Invalid server response. Server may not be running.');
                }
                
                if (response.ok && data.token && data.user) {
                    console.log('‚úÖ Login successful!', data);
                    authToken = data.token;
                    currentUser = data.user;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    console.log('Token saved:', authToken);
                    console.log('User saved:', currentUser);
                    
                    showAlert('loginAlert', '‚úÖ Login successful! Redirecting...', 'success');
                    
                    // Clear form
                    document.getElementById('loginEmail').value = '';
                    document.getElementById('loginPassword').value = '';
                    
                    // Redirect to admin panel
                    setTimeout(() => {
                        console.log('Showing admin panel...');
                        showAdminPanel();
                        loadDashboard();
                        
                        // Show Users tab only for admins
                        if (currentUser && currentUser.role === 'admin') {
                            const usersTab = document.getElementById('usersTab');
                            if (usersTab) {
                                usersTab.style.display = 'inline-block';
                                console.log('Users tab shown for admin');
                            }
                        }
                    }, 800);
                } else {
                    const errorMsg = data.message || 'Login failed. Please check your credentials.';
                    console.error('‚ùå Login failed:', errorMsg);
                    showAlert('loginAlert', '‚ùå ' + errorMsg, 'error');
                    loginBtn.innerHTML = originalText;
                    loginBtn.disabled = false;
                }
            } catch (e) {
                console.error('Login exception:', e);
                const errorMsg = e.message || 'Failed to connect to server. Make sure the backend server is running on port 5000.';
                showAlert('loginAlert', '‚ùå Error: ' + errorMsg, 'error');
                loginBtn.innerHTML = originalText;
                loginBtn.disabled = false;
            }
            });
            
            console.log('Login form handler attached');
        }
        
        // Attach login handler when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', attachLoginHandler);
        } else {
            attachLoginHandler();
        }
        
        // ========== LOCALSTORAGE-BASED STORAGE (FALLBACK) ==========
        // Define API_BASE as empty to prevent errors (we use localStorage instead)
        // const API_BASE = '';
        
        let storageIdCounter = { department: 1, batch: 1, semester: 1, course: 1, instructor: 1, room: 1, schedule: 1, classRepresentative: 1 };
        
        // Note: All data uses localStorage, no fetch needed
        
        // Initialize storage (empty - using real database)
        function initializeStorage() {
            if (!localStorage.getItem('scheduleSystemData')) {
                const emptyData = {
                    departments: [],
                    batches: [],
                    semesters: [],
                    courses: [],
                    instructors: [],
                    rooms: [],
                    schedules: [],
                    classRepresentatives: [],
                    idCounter: storageIdCounter
                };
                localStorage.setItem('scheduleSystemData', JSON.stringify(emptyData));
                console.log('‚úÖ Initialized with empty storage (using real database)');
            } else {
                const data = JSON.parse(localStorage.getItem('scheduleSystemData'));
                storageIdCounter = data.idCounter || storageIdCounter;
            }
        }
        
        // Get all data from localStorage
        function getStorageData() {
            const data = localStorage.getItem('scheduleSystemData');
            return data ? JSON.parse(data) : { departments: [], batches: [], semesters: [], courses: [], instructors: [], rooms: [], schedules: [], classRepresentatives: [], idCounter: storageIdCounter };
        }
        
        // Save data to localStorage
        function saveStorageData(data) {
            data.idCounter = storageIdCounter;
            localStorage.setItem('scheduleSystemData', JSON.stringify(data));
        }
        
        // Generate unique ID
        function generateId(type) {
            const id = `${type}_${Date.now()}_${storageIdCounter[type]++}`;
            saveStorageData(getStorageData()); // Update counter
            return id;
        }
        
        // Initialize on page load
        initializeStorage();
        
        // Function to create sample schedule data based on manual schedule
        // Removed createSampleScheduleData and autoGenerateDemoSchedule functions - using real database now
        
        let token = null;
        // currentUser is already declared above in authentication section
        
        // ========== HELPER FUNCTIONS FOR ALL ENTITIES ==========
        // These functions replace API calls with localStorage operations
        
        // Batches
        function getBatches() {
            return getStorageData().batches || [];
        }
        
        function getBatchById(id) {
            return getBatches().find(b => b._id === id);
        }
        
        function createBatch(data) {
            const storage = getStorageData();
            const batch = {
                _id: generateId('batch'),
                ...data,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            storage.batches.push(batch);
            saveStorageData(storage);
            return batch;
        }
        
        function updateBatch(id, data) {
            const storage = getStorageData();
            const index = storage.batches.findIndex(b => b._id === id);
            if (index === -1) return null;
            storage.batches[index] = { ...storage.batches[index], ...data, updatedAt: new Date().toISOString() };
            saveStorageData(storage);
            return storage.batches[index];
        }
        
        function deleteBatch(id) {
            const storage = getStorageData();
            storage.batches = storage.batches.filter(b => b._id !== id);
            // Also delete related semesters, courses, schedules
            storage.semesters = storage.semesters.filter(s => s.batchId !== id);
            storage.courses = storage.courses.filter(c => c.batchId !== id);
            storage.schedules = storage.schedules.filter(s => s.batchId !== id);
            saveStorageData(storage);
            return true;
        }
        
        // Semesters
        function getSemesters(batchId) {
            const all = getStorageData().semesters || [];
            return batchId ? all.filter(s => s.batchId === batchId) : all;
        }
        
        function getSemesterById(id) {
            return getSemesters().find(s => s._id === id);
        }
        
        function createSemester(data) {
            const storage = getStorageData();
            const semester = {
                _id: generateId('semester'),
                ...data,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            storage.semesters.push(semester);
            saveStorageData(storage);
            return semester;
        }
        
        function updateSemester(id, data) {
            const storage = getStorageData();
            const index = storage.semesters.findIndex(s => s._id === id);
            if (index === -1) return null;
            storage.semesters[index] = { ...storage.semesters[index], ...data, updatedAt: new Date().toISOString() };
            saveStorageData(storage);
            return storage.semesters[index];
        }
        
        function deleteSemester(id) {
            const storage = getStorageData();
            storage.semesters = storage.semesters.filter(s => s._id !== id);
            // Also delete related courses and schedules
            storage.courses = storage.courses.filter(c => c.semesterId !== id);
            storage.schedules = storage.schedules.filter(s => s.semesterId !== id);
            saveStorageData(storage);
            return true;
        }
        
        // Courses
        function getCourses(filter) {
            let courses = getStorageData().courses || [];
            if (filter?.batchId) courses = courses.filter(c => c.batchId === filter.batchId);
            if (filter?.semesterId) courses = courses.filter(c => c.semesterId === filter.semesterId);
            if (filter?.department) courses = courses.filter(c => c.department === filter.department);
            return courses;
        }
        
        function getCourseById(id) {
            return getCourses().find(c => c._id === id);
        }
        
        function createCourse(data) {
            const storage = getStorageData();
            const course = {
                _id: generateId('course'),
                ...data,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            storage.courses.push(course);
            saveStorageData(storage);
            return course;
        }
        
        function updateCourse(id, data) {
            const storage = getStorageData();
            const index = storage.courses.findIndex(c => c._id === id);
            if (index === -1) return null;
            storage.courses[index] = { ...storage.courses[index], ...data, updatedAt: new Date().toISOString() };
            saveStorageData(storage);
            return storage.courses[index];
        }
        
        function deleteCourse(id) {
            const storage = getStorageData();
            storage.courses = storage.courses.filter(c => c._id !== id);
            saveStorageData(storage);
            return true;
        }
        
        // Instructors
        function getInstructors() {
            return getStorageData().instructors || [];
        }
        
        function getInstructorById(id) {
            return getInstructors().find(i => i._id === id);
        }
        
        function createInstructor(data) {
            const storage = getStorageData();
            const instructor = {
                _id: generateId('instructor'),
                ...data,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            storage.instructors.push(instructor);
            saveStorageData(storage);
            return instructor;
        }
        
        function updateInstructor(id, data) {
            const storage = getStorageData();
            const index = storage.instructors.findIndex(i => i._id === id);
            if (index === -1) return null;
            storage.instructors[index] = { ...storage.instructors[index], ...data, updatedAt: new Date().toISOString() };
            saveStorageData(storage);
            return storage.instructors[index];
        }
        
        function deleteInstructor(id) {
            const storage = getStorageData();
            storage.instructors = storage.instructors.filter(i => i._id !== id);
            saveStorageData(storage);
            return true;
        }
        
        // Rooms
        function getRooms() {
            return getStorageData().rooms || [];
        }
        
        function getRoomById(id) {
            return getRooms().find(r => r._id === id);
        }
        
        function createRoom(data) {
            const storage = getStorageData();
            const room = {
                _id: generateId('room'),
                ...data,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            storage.rooms.push(room);
            saveStorageData(storage);
            return room;
        }
        
        function updateRoom(id, data) {
            const storage = getStorageData();
            const index = storage.rooms.findIndex(r => r._id === id);
            if (index === -1) return null;
            storage.rooms[index] = { ...storage.rooms[index], ...data, updatedAt: new Date().toISOString() };
            saveStorageData(storage);
            return storage.rooms[index];
        }
        
        function deleteRoom(id) {
            const storage = getStorageData();
            storage.rooms = storage.rooms.filter(r => r._id !== id);
            saveStorageData(storage);
            return true;
        }
        
        // Schedules
        function getSchedules() {
            return getStorageData().schedules || [];
        }
        
        function getScheduleById(id) {
            return getSchedules().find(s => s._id === id);
        }
        
        function createSchedule(data) {
            const storage = getStorageData();
            const schedule = {
                _id: generateId('schedule'),
                ...data,
                generatedAt: new Date().toISOString(),
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            storage.schedules.push(schedule);
            saveStorageData(storage);
            return schedule;
        }
        
        function updateSchedule(id, data) {
            const storage = getStorageData();
            const index = storage.schedules.findIndex(s => s._id === id);
            if (index === -1) return null;
            storage.schedules[index] = { ...storage.schedules[index], ...data, updatedAt: new Date().toISOString() };
            saveStorageData(storage);
            return storage.schedules[index];
        }
        
        async function deleteSchedule(id) {
            if (!confirm('Delete this schedule? This action cannot be undone.')) return;
            try {
                const response = await fetch(`${API_BASE}/schedules/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                if (response.ok) {
                    loadSchedules();
                    showAlert('scheduleAlert', '‚úÖ Schedule deleted successfully!', 'success');
                } else {
                    const result = await response.json();
                    showAlert('scheduleAlert', '‚ùå ' + (result.message || 'Error deleting schedule'), 'error');
                }
            } catch (e) {
                showAlert('scheduleAlert', '‚ùå Error: ' + e.message, 'error');
            }
        }
        
        window.deleteSchedule = deleteSchedule;
        
        // Client-side schedule generation function
        function generateScheduleClientSide(options) {
            try {
                const { batchId, semesterId, section, department, selectedRoomIds, prioritySettings } = options;
                
                // Get courses for this batch and semester
                const allCourses = getCourses();
                let courses = allCourses.filter(c => c.batchId === batchId && c.semesterId === semesterId);
                
                if (department) {
                    courses = courses.filter(c => c.department === department);
                }
                
                if (courses.length === 0) {
                    return { error: 'No courses found for the selected batch and semester' };
                }
                
                // Get available rooms
                let availableRooms = getRooms().filter(r => r.isAvailable);
                if (selectedRoomIds && selectedRoomIds.length > 0) {
                    availableRooms = availableRooms.filter(r => selectedRoomIds.includes(r._id));
                }
                
                if (availableRooms.length === 0) {
                    return { error: 'No available rooms found' };
                }
                
                // Get instructors
                const instructors = getInstructors();
                
                // Separate major and common courses
                const majorCourses = courses.filter(c => c.majorOrCommon === 'major');
                const commonCourses = courses.filter(c => c.majorOrCommon === 'common');
                
                // Determine shift preferences
                const majorShift = prioritySettings?.majorCoursesShift || 'morning';
                const commonShift = prioritySettings?.commonCoursesShift || 'afternoon';
                
                // Time slots
                const morningSlots = [
                    { start: '08:00', end: '11:00' },
                    { start: '11:00', end: '12:00' }
                ];
                const afternoonSlots = [
                    { start: '14:00', end: '17:00' },
                    { start: '20:00', end: '23:00' }
                ];
                
                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
                const scheduleEntries = [];
                const conflicts = [];
                const warnings = [];
                
                let roomIndex = 0;
                let dayIndex = 0;
                
                // Generate schedule entries
                const allCoursesToSchedule = [...majorCourses, ...commonCourses];
                
                for (const course of allCoursesToSchedule) {
                    const courseShift = course.majorOrCommon === 'major' ? majorShift : commonShift;
                    const slots = courseShift === 'morning' ? morningSlots : afternoonSlots;
                    
                    // Get instructor
                    const instructor = instructors.find(i => i._id === course.instructorId) || instructors.find(i => i.fullName === 'TBA') || instructors[0];
                    
                    // Assign lecture
                    const lectureSlot = slots[0];
                    const lectureRoom = availableRooms[roomIndex % availableRooms.length];
                    roomIndex++;
                    
                    scheduleEntries.push({
                        courseId: course._id,
                        courseCode: course.courseCode,
                        courseName: course.courseName,
                        instructorId: instructor._id,
                        instructorName: instructor.fullName,
                        roomId: lectureRoom._id,
                        roomNumber: lectureRoom.roomNumber,
                        day: days[dayIndex % days.length],
                        dayOfWeek: days[dayIndex % days.length],
                        shift: courseShift,
                        startTime: lectureSlot.start,
                        endTime: lectureSlot.end,
                        isLab: false,
                        type: 'lecture'
                    });
                    
                    dayIndex++;
                    
                    // Assign lab if course has lab
                    if (course.hasLab) {
                        const labRoom = availableRooms.find(r => r.roomType === 'lab') || availableRooms[roomIndex % availableRooms.length];
                        const labSlot = slots[slots.length - 1];
                        
                        scheduleEntries.push({
                            courseId: course._id,
                            courseCode: course.courseCode,
                            courseName: course.courseName + ' [Lab]',
                            instructorId: instructor._id,
                            instructorName: instructor.fullName,
                            roomId: labRoom._id,
                            roomNumber: labRoom.roomNumber,
                            day: days[dayIndex % days.length],
                            dayOfWeek: days[dayIndex % days.length],
                            shift: courseShift,
                            startTime: labSlot.start,
                            endTime: labSlot.end,
                            isLab: true,
                            type: 'lab'
                        });
                        
                        dayIndex++;
                        roomIndex++;
                    }
                }
                
                // Check for conflicts
                const timeSlots = {};
                scheduleEntries.forEach(entry => {
                    const key = `${entry.day}_${entry.startTime}_${entry.roomId}`;
                    if (timeSlots[key]) {
                        conflicts.push({
                            type: 'room_conflict',
                            message: `Room ${entry.roomNumber} is double-booked on ${entry.day} at ${entry.startTime}`
                        });
                    } else {
                        timeSlots[key] = entry;
                    }
                });
                
                // Create schedule
                const schedule = createSchedule({
                    batchId: batchId,
                    semesterId: semesterId,
                    section: section,
                    department: department,
                    entries: scheduleEntries,
                    status: 'draft'
                });
                
                return {
                    schedule: schedule,
                    conflicts: conflicts,
                    warnings: warnings,
                    message: 'Schedule generated successfully'
                };
            } catch (e) {
                return { error: e.message || 'Failed to generate schedule' };
            }
        }
        
        window.generateScheduleClientSide = generateScheduleClientSide;
        
        // Class Representatives
        function getClassRepresentatives() {
            return getStorageData().classRepresentatives || [];
        }
        
        function getClassRepresentativeById(id) {
            return getClassRepresentatives().find(cr => cr._id === id);
        }
        
        function createClassRepresentative(data) {
            const storage = getStorageData();
            const cr = {
                _id: generateId('classRepresentative'),
                ...data,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            storage.classRepresentatives.push(cr);
            saveStorageData(storage);
            return cr;
        }
        
        function updateClassRepresentative(id, data) {
            const storage = getStorageData();
            const index = storage.classRepresentatives.findIndex(cr => cr._id === id);
            if (index === -1) return null;
            storage.classRepresentatives[index] = { ...storage.classRepresentatives[index], ...data, updatedAt: new Date().toISOString() };
            saveStorageData(storage);
            return storage.classRepresentatives[index];
        }
        
        async function deleteClassRepresentative(id) {
            if (!confirm('Delete this class representative? This action cannot be undone.')) return;
            try {
                const response = await fetch(`${API_BASE}/class-representatives/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                if (response.ok) {
                    loadClassRepresentatives();
                    showAlert('classRepAlert', '‚úÖ Class representative deleted successfully!', 'success');
                } else {
                    const result = await response.json();
                    showAlert('classRepAlert', '‚ùå ' + (result.message || 'Error deleting class representative'), 'error');
                }
            } catch (e) {
                showAlert('classRepAlert', '‚ùå Error: ' + e.message, 'error');
            }
        }
        
        window.deleteClassRepresentative = deleteClassRepresentative;
        
        // Auto-login and load dashboard
        loadDashboard();
        
        // Load departments after DOM is ready
        setTimeout(() => {
            loadDepartments(); // Load departments table
            loadDepartmentsForDropdowns(); // Load departments from localStorage into all dropdowns
        }, 200);
        
        // Also load when page fully loads
        window.addEventListener('load', () => {
            setTimeout(() => {
                loadDepartmentsForDropdowns();
            }, 300);
        });

        // Make showTab globally accessible for onclick handlers
        window.showTab = function(tabName) {
            try {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                
                // Find and activate the clicked tab button
                const tabs = document.querySelectorAll('.tab');
                tabs.forEach(tab => {
                    if (tab.getAttribute('onclick')?.includes(`'${tabName}'`)) {
                        tab.classList.add('active');
                    }
                });
                
                const tabContent = document.getElementById(tabName);
                if (tabContent) {
                    tabContent.classList.add('active');
                }
                
                // Load data for the tab
                if (tabName === 'users') loadUsers();
                if (tabName === 'batches') {
                    loadBatches();
                }
                if (tabName === 'semesters') loadSemesters();
                if (tabName === 'courses') { 
                    loadCourses(); 
                    loadCourseFormDropdowns(); // Load dropdowns from API
                    setTimeout(() => loadDepartmentsForDropdowns(), 100); 
                }
                if (tabName === 'instructors') loadInstructors();
                if (tabName === 'schedules') { loadSchedules(); loadRoomsForSelection(); setTimeout(() => loadDepartmentsForDropdowns(), 100); }
                if (tabName === 'rooms') loadRooms();
                if (tabName === 'departments') loadDepartments();
                if (tabName === 'classRepresentatives') loadClassRepresentatives();
            } catch (e) {
                console.error('Error in showTab:', e);
            }
        };

        async function loadDashboard() {
            const emailDisplay = document.getElementById('currentUserEmail');
            const roleDisplay = document.getElementById('currentUserRoleDisplay');
            if (emailDisplay) emailDisplay.textContent = currentUser?.email || 'System Admin';
            if (roleDisplay) roleDisplay.textContent = currentUser?.role || 'Admin';
            
            try {
                const [batchesResponse, coursesResponse, instructorsResponse, schedulesResponse] = await Promise.all([
                    fetch(`${API_BASE}/batches`, { headers: { 'Authorization': `Bearer ${authToken}` } }).catch(() => ({ json: () => [] })),
                    fetch(`${API_BASE}/courses`, { headers: { 'Authorization': `Bearer ${authToken}` } }).catch(() => ({ json: () => [] })),
                    fetch(`${API_BASE}/instructors`, { headers: { 'Authorization': `Bearer ${authToken}` } }).catch(() => ({ json: () => [] })),
                    fetch(`${API_BASE}/schedules`, { headers: { 'Authorization': `Bearer ${authToken}` } }).catch(() => ({ json: () => [] }))
                ]);
                
                const batches = await batchesResponse.json();
                const courses = await coursesResponse.json();
                const instructors = await instructorsResponse.json();
                const schedules = await schedulesResponse.json();
                
                document.getElementById('statBatches').textContent = batches.length || 0;
                document.getElementById('statCourses').textContent = courses.length || 0;
                document.getElementById('statInstructors').textContent = instructors.length || 0;
                document.getElementById('statSchedules').textContent = schedules.length || 0;
            } catch (e) {
                console.error('Error loading dashboard:', e);
            }
        }
        
        window.loadDashboard = loadDashboard;

        // Batches
        let editingBatchId = null;
        
        document.getElementById('batchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                batchNumber: document.getElementById('batchNumber').value,
                numberOfYears: parseInt(document.getElementById('numberOfYears').value),
                sections: document.getElementById('sections').value.split(',').map(s => s.trim()),
                departments: [] // Departments removed from batch creation
            };

            try {
                const url = editingBatchId ? `${API_BASE}/batches/${editingBatchId}` : `${API_BASE}/batches`;
                const method = editingBatchId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('batchAlert', '‚úÖ ' + (editingBatchId ? 'Batch updated' : 'Batch created') + ' successfully!', 'success');
                    document.getElementById('batchForm').reset();
                    editingBatchId = null;
                    document.getElementById('batchSubmitBtn').textContent = 'Create Batch';
                    document.getElementById('batchCancelBtn').style.display = 'none';
                    loadBatches();
                    loadDashboard();
                } else {
                    showAlert('batchAlert', '‚ùå ' + (result.message || 'Error saving batch'), 'error');
                }
            } catch (e) {
                showAlert('batchAlert', '‚ùå Error: ' + e.message, 'error');
            }
        });

        window.editBatch = async function(id) {
            try {
                const response = await fetch(`${API_BASE}/batches/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                const batch = await response.json();
                if (!batch) {
                    alert('Batch not found');
                    return;
                }
                
                editingBatchId = id;
                document.getElementById('batchNumber').value = batch.batchNumber;
                document.getElementById('numberOfYears').value = batch.numberOfYears;
                document.getElementById('sections').value = (batch.sections || []).join(', ');
                
                document.getElementById('batchSubmitBtn').textContent = 'Update Batch';
                document.getElementById('batchCancelBtn').style.display = 'inline-block';
                
                // Scroll to form
                document.getElementById('batchForm').scrollIntoView({ behavior: 'smooth', block: 'center' });
            } catch (e) {
                alert('Error loading batch: ' + e.message);
            }
        };

        window.cancelBatchEdit = function() {
            editingBatchId = null;
            document.getElementById('batchForm').reset();
            document.getElementById('batchSubmitBtn').textContent = 'Create Batch';
            document.getElementById('batchCancelBtn').style.display = 'none';
        };

        async function loadBatches() {
            try {
                const response = await fetch(`${API_BASE}/batches`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                const batches = await response.json();
                const tbody = document.querySelector('#batchesTable tbody');
                if (!tbody) return;
                
                if (batches.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px; color: #999;">No batches found. Create one to get started!</td></tr>';
                    return;
                }
                
                // Sort by batch number
                batches.sort((a, b) => {
                    // Try to compare as numbers first, then as strings
                    const aNum = parseInt(a.batchNumber);
                    const bNum = parseInt(b.batchNumber);
                    if (!isNaN(aNum) && !isNaN(bNum)) {
                        return bNum - aNum;
                    }
                    return b.batchNumber.localeCompare(a.batchNumber);
                });
                
                tbody.innerHTML = batches.map(b => `
                    <tr>
                        <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;">${b.batchNumber}</td>
                        <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;">${b.numberOfYears}</td>
                        <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;">${(b.sections || []).join(', ')}</td>
                        <td style="padding: 15px; border-bottom: 1px solid #e5e7eb; display: flex; gap: 8px;">
                            <button onclick="editBatch('${b._id}')" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">‚úèÔ∏è Edit</button>
                            <button class="btn-danger" onclick="deleteBatch('${b._id}')" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">üóëÔ∏è Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Error loading batches:', e);
                const tbody = document.querySelector('#batchesTable tbody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px; color: #ef4444;">Error loading batches: ' + e.message + '</td></tr>';
                }
            }
        }
        
        window.loadBatches = loadBatches;

        window.deleteBatch = async function(id) {
            if (!confirm('Delete this batch? This will also delete related semesters, courses, and schedules.')) return;
            try {
                const response = await fetch(`${API_BASE}/batches/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                if (response.ok) {
                    loadBatches();
                    loadDashboard();
                    showAlert('batchAlert', '‚úÖ Batch deleted successfully!', 'success');
                } else {
                    const result = await response.json();
                    showAlert('batchAlert', '‚ùå ' + (result.message || 'Error deleting batch'), 'error');
                }
            } catch (e) {
                alert('Error deleting batch: ' + e.message);
            }
        };

        // Semesters
        let editingSemesterId = null;
        
        document.getElementById('semesterForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                batchId: document.getElementById('semesterBatchId').value,
                semesterNumber: parseInt(document.getElementById('semesterNumber').value),
                name: document.getElementById('semesterName').value,
                isActive: true
            };

            try {
                const url = editingSemesterId ? `${API_BASE}/semesters/${editingSemesterId}` : `${API_BASE}/semesters`;
                const method = editingSemesterId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('semesterAlert', '‚úÖ ' + (editingSemesterId ? 'Semester updated' : 'Semester created') + ' successfully!', 'success');
                    document.getElementById('semesterForm').reset();
                    editingSemesterId = null;
                    document.getElementById('semesterSubmitBtn').textContent = 'Create Semester';
                    document.getElementById('semesterCancelBtn').style.display = 'none';
                    loadSemesters();
                    loadDashboard();
                } else {
                    showAlert('semesterAlert', '‚ùå ' + (result.message || 'Error saving semester'), 'error');
                }
            } catch (e) {
                showAlert('semesterAlert', '‚ùå Error: ' + e.message, 'error');
            }
        });

        async function editSemester(id) {
            try {
                const [semesterResponse, batchesResponse] = await Promise.all([
                    fetch(`${API_BASE}/semesters/${id}`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    }),
                    fetch(`${API_BASE}/batches`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    })
                ]);
                
                if (semesterResponse.status === 401 || batchesResponse.status === 401) {
                    logout();
                    return;
                }
                
                const semester = await semesterResponse.json();
                const batches = await batchesResponse.json();
                
                if (!semester) {
                    alert('Semester not found');
                    return;
                }
                
                editingSemesterId = id;
                const batchId = semester.batchId?._id || semester.batchId;
                document.getElementById('semesterBatchId').value = batchId;
                document.getElementById('semesterNumber').value = semester.semesterNumber;
                document.getElementById('semesterName').value = semester.name;
                document.getElementById('semesterSubmitBtn').textContent = 'Update Semester';
                document.getElementById('semesterCancelBtn').style.display = 'inline-block';
                
                // Load batches for dropdown
                const batchSelect = document.getElementById('semesterBatchId');
                batchSelect.innerHTML = '<option value="">Select Batch</option>' + batches.map(b => 
                    `<option value="${b._id}" ${b._id === batchId ? 'selected' : ''}>${b.batchNumber}</option>`
                ).join('');
                
                document.getElementById('semesterForm').scrollIntoView({ behavior: 'smooth', block: 'center' });
            } catch (e) {
                alert('Error loading semester: ' + e.message);
            }
        }
        
        window.editSemester = editSemester;
        
        window.editSemester = editSemester;

        function cancelSemesterEdit() {
            editingSemesterId = null;
            document.getElementById('semesterForm').reset();
            document.getElementById('semesterSubmitBtn').textContent = 'Create Semester';
            document.getElementById('semesterCancelBtn').style.display = 'none';
        }

        async function loadSemesters() {
            try {
                const [semestersResponse, batchesResponse] = await Promise.all([
                    fetch(`${API_BASE}/semesters`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    }),
                    fetch(`${API_BASE}/batches`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    })
                ]);
                
                if (semestersResponse.status === 401 || batchesResponse.status === 401) {
                    logout();
                    return;
                }
                
                const semesters = await semestersResponse.json();
                const batches = await batchesResponse.json();
                const tbody = document.querySelector('#semestersTable tbody');
                if (!tbody) return;
                
                if (semesters.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px; color: #999;">No semesters found. Create one to get started!</td></tr>';
                } else {
                    tbody.innerHTML = semesters.map(s => {
                        const batchId = s.batchId?._id || s.batchId;
                        const batch = batches.find(b => (b._id === batchId) || (b._id === batchId?._id));
                        return `
                            <tr>
                                <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;">${batch ? batch.batchNumber : 'N/A'}</td>
                                <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;">${s.semesterNumber}</td>
                                <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;">${s.name}</td>
                                <td style="padding: 15px; border-bottom: 1px solid #e5e7eb; display: flex; gap: 8px;">
                                    <button onclick="editSemester('${s._id}')" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">‚úèÔ∏è Edit</button>
                                    <button class="btn-danger" onclick="deleteSemester('${s._id}')" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">üóëÔ∏è Delete</button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }

                // Populate batch dropdown
                const batchSelect = document.getElementById('semesterBatchId');
                if (batchSelect) {
                    batchSelect.innerHTML = '<option value="">Select Batch</option>' + batches.map(b => 
                        `<option value="${b._id}">${b.batchNumber}</option>`
                    ).join('');
                }
            } catch (e) {
                console.error('Error loading semesters:', e);
                const tbody = document.querySelector('#semestersTable tbody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px; color: #ef4444;">Error loading semesters: ' + e.message + '</td></tr>';
                }
            }
        }
        
        window.loadSemesters = loadSemesters;

        window.deleteSemester = async function(id) {
            if (!confirm('Delete this semester? This will also delete related courses and schedules.')) return;
            try {
                const response = await fetch(`${API_BASE}/semesters/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                if (response.ok) {
                    loadSemesters();
                    loadDashboard();
                    showAlert('semesterAlert', '‚úÖ Semester deleted successfully!', 'success');
                } else {
                    const result = await response.json();
                    showAlert('semesterAlert', '‚ùå ' + (result.message || 'Error deleting semester'), 'error');
                }
            } catch (e) {
                alert('Error deleting semester: ' + e.message);
            }
        };

        // Courses
        let editingCourseId = null;
        
        document.getElementById('courseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const creditHour = parseInt(document.getElementById('creditHour').value);
            const hasLab = document.getElementById('hasLab').checked;
            const lectureHours = hasLab && creditHour === 5 ? 2 : creditHour;
            const labHours = hasLab && creditHour === 5 ? 3 : 0;
            
            const data = {
                courseName: document.getElementById('courseName').value,
                courseCode: document.getElementById('courseCode').value,
                creditHour: creditHour,
                majorOrCommon: document.getElementById('majorOrCommon').value,
                batchId: document.getElementById('courseBatchId').value,
                semesterId: document.getElementById('courseSemesterId').value,
                instructorId: document.getElementById('instructorId').value,
                department: document.getElementById('courseDepartment').value || undefined,
                hasLab: hasLab,
                lectureHours: lectureHours,
                labHours: labHours
            };

            try {
                const url = editingCourseId ? `${API_BASE}/courses/${editingCourseId}` : `${API_BASE}/courses`;
                const method = editingCourseId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }

                const result = await response.json();
                if (response.ok) {
                    showAlert('courseAlert', '‚úÖ ' + (editingCourseId ? 'Course updated' : 'Course created') + ' successfully!', 'success');
                    cancelCourseEdit();
                    loadCourses();
                    loadCourseFormDropdowns(); // Reload dropdowns
                } else {
                    showAlert('courseAlert', '‚ùå ' + (result.message || 'Error saving course'), 'error');
                }
            } catch (e) {
                showAlert('courseAlert', '‚ùå Error: ' + e.message, 'error');
            }
        });

        async function editCourse(id) {
            try {
                const response = await fetch(`${API_BASE}/courses/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                const course = await response.json();
                
                editingCourseId = id;
                document.getElementById('courseName').value = course.courseName || '';
                document.getElementById('courseCode').value = course.courseCode || '';
                document.getElementById('creditHour').value = course.creditHour || '';
                document.getElementById('majorOrCommon').value = course.majorOrCommon || 'major';
                document.getElementById('hasLab').checked = course.hasLab || false;
                
                // Set department dropdown value
                const courseDeptSelect = document.getElementById('courseDepartment');
                if (courseDeptSelect) {
                    courseDeptSelect.value = course.department || '';
                }
                
                // Load dropdowns from API
                await loadCourseFormDropdowns();
                
                // Set selected values after dropdowns are loaded
                const batchId = course.batchId?._id || course.batchId;
                const semesterId = course.semesterId?._id || course.semesterId;
                const instructorId = course.instructorId?._id || course.instructorId;
                
                if (batchId) {
                    document.getElementById('courseBatchId').value = batchId;
                    // Trigger change to load semesters
                    document.getElementById('courseBatchId').dispatchEvent(new Event('change'));
                    
                    // Wait a bit for semesters to load, then set semester
                    setTimeout(() => {
                        if (semesterId) {
                            document.getElementById('courseSemesterId').value = semesterId;
                        }
                    }, 300);
                }
                
                if (instructorId) {
                    document.getElementById('instructorId').value = instructorId;
                }
                
                document.getElementById('courseSubmitBtn').textContent = 'Update Course';
                document.getElementById('courseCancelBtn').style.display = 'inline-block';
                document.getElementById('courseForm').scrollIntoView({ behavior: 'smooth', block: 'center' });
            } catch (e) {
                showAlert('courseAlert', '‚ùå Error loading course: ' + e.message, 'error');
            }
        }
        
        window.editCourse = editCourse;

        function cancelCourseEdit() {
            editingCourseId = null;
            document.getElementById('courseForm').reset();
            document.getElementById('courseSubmitBtn').textContent = 'Create Course';
            document.getElementById('courseCancelBtn').style.display = 'none';
            loadCourseFormDropdowns(); // Reload dropdowns when canceling edit
        }
        
        window.cancelCourseEdit = cancelCourseEdit;

        async function loadCourses() {
            try {
                const response = await fetch(`${API_BASE}/courses`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                const courses = await response.json();
                const tbody = document.querySelector('#coursesTable tbody');
                if (!tbody) return;
                
                if (courses.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">No courses found. Create one to get started!</td></tr>';
                    return;
                }
                
                // Fetch related data for display
                const [batches, semesters, instructors] = await Promise.all([
                    fetch(`${API_BASE}/batches`, { headers: { 'Authorization': `Bearer ${authToken}` } }).then(r => r.json()).catch(() => []),
                    fetch(`${API_BASE}/semesters`, { headers: { 'Authorization': `Bearer ${authToken}` } }).then(r => r.json()).catch(() => []),
                    fetch(`${API_BASE}/instructors`, { headers: { 'Authorization': `Bearer ${authToken}` } }).then(r => r.json()).catch(() => [])
                ]);
                
                tbody.innerHTML = courses.map(c => {
                    const instructor = instructors.find(i => i._id === (c.instructorId?._id || c.instructorId));
                    const batch = batches.find(b => b._id === (c.batchId?._id || c.batchId));
                    const semester = semesters.find(s => s._id === (c.semesterId?._id || c.semesterId));
                    return `
                    <tr>
                        <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;">${c.courseCode || 'N/A'}</td>
                        <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;">${c.courseName || 'N/A'}</td>
                        <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;">${c.creditHour || 'N/A'}</td>
                        <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;">${c.majorOrCommon || 'N/A'}</td>
                        <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;">${c.hasLab ? 'Yes' : 'No'}</td>
                        <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;">${instructor ? instructor.fullName : 'N/A'}</td>
                        <td style="padding: 15px; border-bottom: 1px solid #e5e7eb; display: flex; gap: 8px;">
                            <button onclick="editCourse('${c._id}')" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">‚úèÔ∏è Edit</button>
                            <button class="btn-danger" onclick="deleteCourse('${c._id}')" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">üóëÔ∏è Delete</button>
                        </td>
                    </tr>
                    `;
                }).join('');
            } catch (e) {
                console.error('Error loading courses:', e);
                const tbody = document.querySelector('#coursesTable tbody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #ef4444;">Error loading courses: ' + e.message + '</td></tr>';
                }
            }
        }
        
        // Function to load dropdowns for course form from API
        async function loadCourseFormDropdowns() {
            try {
                console.log('Loading course form dropdowns from MongoDB...');
                const [batches, semesters, instructors] = await Promise.all([
                    fetch(`${API_BASE}/batches`).then(r => {
                        if (!r.ok) throw new Error(`Batches API error: ${r.status}`);
                        return r.json();
                    }).catch(err => {
                        console.error('Error fetching batches:', err);
                        return [];
                    }),
                    fetch(`${API_BASE}/semesters`).then(r => {
                        if (!r.ok) throw new Error(`Semesters API error: ${r.status}`);
                        return r.json();
                    }).catch(err => {
                        console.error('Error fetching semesters:', err);
                        return [];
                    }),
                    fetch(`${API_BASE}/instructors`).then(r => {
                        if (!r.ok) throw new Error(`Instructors API error: ${r.status}`);
                        return r.json();
                    }).catch(err => {
                        console.error('Error fetching instructors:', err);
                        return [];
                    })
                ]);
                
                console.log('Fetched data:', { 
                    batches: batches.length, 
                    semesters: semesters.length, 
                    instructors: instructors.length 
                });
                
                // Populate Batch dropdown
                const batchSelect = document.getElementById('courseBatchId');
                if (batchSelect) {
                    batchSelect.innerHTML = '<option value="">Select Batch</option>' + batches.map(b => 
                        `<option value="${b._id}">${b.batchNumber || 'N/A'}</option>`
                    ).join('');
                    
                    // Remove existing change listeners by cloning
                    const newBatchSelect = batchSelect.cloneNode(true);
                    batchSelect.parentNode.replaceChild(newBatchSelect, batchSelect);
                    
                    // Add change listener to update semesters when batch changes
                    newBatchSelect.addEventListener('change', function(e) {
                        const batchId = e.target.value;
                        const semesterSelect = document.getElementById('courseSemesterId');
                        if (semesterSelect && batchId) {
                            const batchSemesters = semesters.filter(s => {
                                // Handle both populated and non-populated batchId
                                const sBatchId = s.batchId?._id || s.batchId;
                                const batchIdStr = batchId.toString();
                                const sBatchIdStr = sBatchId?.toString() || sBatchId;
                                return sBatchIdStr === batchIdStr;
                            });
                            console.log('Filtered semesters for batch', batchId, ':', batchSemesters.length, batchSemesters);
                            semesterSelect.innerHTML = '<option value="">Select Semester</option>' + batchSemesters.map(s => 
                                `<option value="${s._id}">${s.name || `Semester ${s.semesterNumber}`}</option>`
                            ).join('');
                        } else if (semesterSelect) {
                            semesterSelect.innerHTML = '<option value="">Select Semester</option>';
                        }
                    });
                }
                
                // Populate Instructor dropdown
                const instructorSelect = document.getElementById('instructorId');
                if (instructorSelect) {
                    instructorSelect.innerHTML = '<option value="">Select Instructor</option>' + instructors.map(i => 
                        `<option value="${i._id}">${i.fullName || 'N/A'} ${i.idNumber ? '(' + i.idNumber + ')' : ''}</option>`
                    ).join('');
                }
                
                console.log('Course form dropdowns loaded:', { batches: batches.length, semesters: semesters.length, instructors: instructors.length });
            } catch (e) {
                console.error('Error loading course form dropdowns:', e);
                showAlert('courseAlert', '‚ùå Error loading form data: ' + e.message, 'error');
            }
        }
        
        window.loadCourses = loadCourses;
        window.loadCourseFormDropdowns = loadCourseFormDropdowns;

        async function deleteCourse(id) {
            if (!confirm('Delete this course? This action cannot be undone.')) return;
            try {
                const response = await fetch(`${API_BASE}/courses/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                if (response.ok) {
                    loadCourses();
                    showAlert('courseAlert', '‚úÖ Course deleted successfully!', 'success');
                } else {
                    const result = await response.json();
                    showAlert('courseAlert', '‚ùå ' + (result.message || 'Error deleting course'), 'error');
                }
            } catch (e) {
                showAlert('courseAlert', '‚ùå Error deleting course: ' + e.message, 'error');
            }
        }
        
        window.deleteCourse = deleteCourse;

        // Instructors
        let editingInstructorId = null;
        
        document.getElementById('instructorForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                fullName: document.getElementById('instructorFullName').value,
                phoneNumber: document.getElementById('instructorPhone').value,
                idNumber: document.getElementById('idNumber').value,
                profession: document.getElementById('profession').value,
                position: document.getElementById('position').value,
                maxTeachingLoad: parseInt(document.getElementById('maxTeachingLoad').value)
            };

            try {
                const url = editingInstructorId ? `${API_BASE}/instructors/${editingInstructorId}` : `${API_BASE}/instructors`;
                const method = editingInstructorId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('instructorAlert', '‚úÖ ' + (editingInstructorId ? 'Instructor updated' : 'Instructor created') + ' successfully!', 'success');
                    document.getElementById('instructorForm').reset();
                    editingInstructorId = null;
                    document.getElementById('instructorSubmitBtn').textContent = 'Create Instructor';
                    document.getElementById('instructorCancelBtn').style.display = 'none';
                    loadInstructors();
                } else {
                    showAlert('instructorAlert', '‚ùå ' + (result.message || 'Error saving instructor'), 'error');
                }
            } catch (e) {
                showAlert('instructorAlert', '‚ùå Error: ' + e.message, 'error');
            }
        });

        async function editInstructor(id) {
            try {
                const response = await fetch(`${API_BASE}/instructors/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                const instructor = await response.json();
                if (!instructor) {
                    alert('Instructor not found');
                    return;
                }
                
                editingInstructorId = id;
                document.getElementById('instructorFullName').value = instructor.fullName || '';
                document.getElementById('instructorPhone').value = instructor.phoneNumber || '';
                document.getElementById('idNumber').value = instructor.idNumber || '';
                document.getElementById('profession').value = instructor.profession || '';
                document.getElementById('position').value = instructor.position || '';
                document.getElementById('maxTeachingLoad').value = instructor.maxTeachingLoad || 12;
                document.getElementById('instructorSubmitBtn').textContent = 'Update Instructor';
                document.getElementById('instructorCancelBtn').style.display = 'inline-block';
                
                document.getElementById('instructorForm').scrollIntoView({ behavior: 'smooth', block: 'center' });
            } catch (e) {
                alert('Error loading instructor: ' + e.message);
            }
        }
        
        window.editInstructor = editInstructor;

        function cancelInstructorEdit() {
            editingInstructorId = null;
            document.getElementById('instructorForm').reset();
            document.getElementById('instructorSubmitBtn').textContent = 'Create Instructor';
            document.getElementById('instructorCancelBtn').style.display = 'none';
        }
        
        window.cancelInstructorEdit = cancelInstructorEdit;

        async function loadInstructors() {
            try {
                const response = await fetch(`${API_BASE}/instructors`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                const instructors = await response.json();
                const tbody = document.querySelector('#instructorsTable tbody');
                if (!tbody) return;
                
                if (instructors.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">No instructors found. Create one to get started!</td></tr>';
                    return;
                }
                
                tbody.innerHTML = instructors.map(i => `
                    <tr>
                        <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;"><strong>${i.fullName}</strong></td>
                        <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;">${i.phoneNumber || 'N/A'}</td>
                        <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;">${i.idNumber || 'N/A'}</td>
                        <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;">${i.position || 'N/A'}</td>
                        <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;">${i.profession || 'N/A'}</td>
                        <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;">${i.maxTeachingLoad || 0} credits</td>
                        <td style="padding: 15px; border-bottom: 1px solid #e5e7eb; display: flex; gap: 8px;">
                            <button onclick="editInstructor('${i._id}')" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">‚úèÔ∏è Edit</button>
                            <button class="btn-danger" onclick="deleteInstructor('${i._id}')" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">üóëÔ∏è Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Error loading instructors:', e);
                const tbody = document.querySelector('#instructorsTable tbody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #ef4444;">Error loading instructors: ' + e.message + '</td></tr>';
                }
            }
        }
        
        window.loadInstructors = loadInstructors;

        async function deleteInstructor(id) {
            if (!confirm('Delete this instructor?')) return;
            try {
                const response = await fetch(`${API_BASE}/instructors/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                if (response.ok) {
                    loadInstructors();
                    showAlert('instructorAlert', '‚úÖ Instructor deleted successfully!', 'success');
                } else {
                    const result = await response.json();
                    showAlert('instructorAlert', '‚ùå ' + (result.message || 'Error deleting instructor'), 'error');
                }
            } catch (e) {
                alert('Error deleting instructor: ' + e.message);
            }
        }
        
        window.deleteInstructor = deleteInstructor;

        // Schedules
        const scheduleForm = document.getElementById('scheduleForm');
        const scheduleSubmitBtn = document.querySelector('button[form="scheduleForm"]');
        
        if (scheduleForm && scheduleSubmitBtn) {
            scheduleForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const batchId = document.getElementById('scheduleBatchId').value;
                const semesterId = document.getElementById('scheduleSemesterId').value;
                const section = document.getElementById('scheduleSection').value;
                
                if (!batchId || !semesterId || !section) {
                    showAlert('scheduleAlert', '‚ö†Ô∏è Please fill in all required fields (Batch, Semester, Section)', 'error');
                    return;
                }
                
                const originalText = scheduleSubmitBtn.innerHTML;
                scheduleSubmitBtn.innerHTML = '‚è≥ Generating...';
                scheduleSubmitBtn.disabled = true;
                
                // Collect all form data including new features
                const selectedRoomIds = Array.from(document.querySelectorAll('#roomSelection input[type="checkbox"]:checked'))
                    .map(cb => cb.value);
                
                const prioritySettings = {
                    majorCoursesShift: document.getElementById('majorCoursesShift').value,
                    commonCoursesShift: document.getElementById('commonCoursesShift').value,
                };
                
                const data = {
                    batchId: batchId,
                    semesterId: semesterId,
                    section: section,
                    department: document.getElementById('scheduleDepartment').value || undefined,
                    selectedRoomIds: selectedRoomIds.length > 0 ? selectedRoomIds : undefined,
                    prioritySettings: prioritySettings,
                };

                try {
                    console.log('Generating schedule with data:', data);
                    
                    // Generate schedule via API
                    const response = await fetch(`${API_BASE}/schedules/generate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify(data)
                    });
                    
                    if (response.status === 401) {
                        logout();
                        return;
                    }
                    
                    const result = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(result.message || 'Failed to generate schedule');
                    }
                    
                    console.log('Schedule generation result:', result);
                    
                    showAlert('scheduleAlert', '‚úÖ Schedule generated successfully!', 'success');
                    
                    // Show preview
                    if (result.schedule) {
                        showSchedulePreview(result.schedule, result.conflicts || [], result.warnings || []);
                    }
                    
                    // Reload schedules list
                    loadSchedules();
                    
                    scheduleSubmitBtn.innerHTML = '‚úÖ Generated!';
                    setTimeout(() => {
                        scheduleSubmitBtn.innerHTML = originalText;
                        scheduleSubmitBtn.disabled = false;
                    }, 2000);
                } catch (e) {
                    console.error('Schedule generation error:', e);
                    showAlert('scheduleAlert', '‚ùå Error: ' + (e.message || 'Failed to generate schedule'), 'error');
                    scheduleSubmitBtn.innerHTML = originalText;
                    scheduleSubmitBtn.disabled = false;
                }
            });
        }

        function showSchedulePreview(schedule, conflicts, warnings) {
            const previewDiv = document.getElementById('schedulePreview');
            const contentDiv = document.getElementById('previewContent');
            
            let html = `<div style="margin-bottom: 20px;">
                <h4 style="color: #8B0000; margin-bottom: 15px;">üìä Schedule Summary</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="background: #f0f9ff; padding: 15px; border-radius: 10px; border-left: 4px solid #3b82f6;">
                        <div style="font-size: 24px; font-weight: 700; color: #3b82f6;">${schedule.entries?.length || 0}</div>
                        <div style="color: #666; font-size: 14px;">Total Classes</div>
                    </div>
                    <div style="background: #fef3c7; padding: 15px; border-radius: 10px; border-left: 4px solid #f59e0b;">
                        <div style="font-size: 24px; font-weight: 700; color: #f59e0b;">${conflicts.length}</div>
                        <div style="color: #666; font-size: 14px;">Conflicts</div>
                    </div>
                    <div style="background: #f3f4f6; padding: 15px; border-radius: 10px; border-left: 4px solid #6b7280;">
                        <div style="font-size: 24px; font-weight: 700; color: #6b7280;">${warnings.length}</div>
                        <div style="color: #666; font-size: 14px;">Warnings</div>
                    </div>
                </div>
            </div>`;
            
            if (conflicts.length > 0) {
                html += `<div style="background: #fee2e2; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #ef4444;">
                    <h4 style="color: #dc2626; margin-top: 0;">‚ö†Ô∏è Conflicts Detected</h4>
                    <ul style="margin: 0; padding-left: 20px;">
                        ${conflicts.map(c => `<li style="color: #991b1b; margin: 5px 0;">${c.message}</li>`).join('')}
                    </ul>
                </div>`;
            }
            
            if (warnings.length > 0) {
                html += `<div style="background: #fef3c7; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #f59e0b;">
                    <h4 style="color: #d97706; margin-top: 0;">‚ÑπÔ∏è Warnings</h4>
                    <ul style="margin: 0; padding-left: 20px;">
                        ${warnings.map(w => `<li style="color: #92400e; margin: 5px 0;">${w}</li>`).join('')}
                    </ul>
                </div>`;
            }
            
            contentDiv.innerHTML = html;
            previewDiv.style.display = 'block';
        }

        async function publishSchedule(id) {
            if (!confirm('Publish this schedule? It will be visible to instructors.')) return;
            try {
                const response = await fetch(`${API_BASE}/schedules/${id}/publish`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                if (response.ok) {
                    loadSchedules();
                    showAlert('scheduleAlert', '‚úÖ Schedule published successfully!', 'success');
                } else {
                    const result = await response.json();
                    showAlert('scheduleAlert', '‚ùå ' + (result.message || 'Error publishing schedule'), 'error');
                }
            } catch (e) {
                showAlert('scheduleAlert', '‚ùå Error: ' + e.message, 'error');
            }
        }
        
        window.publishSchedule = publishSchedule;

        async function loadSchedules() {
            try {
                console.log('Loading schedules from MongoDB...');
                
                const [schedulesResponse, batchesResponse, semestersResponse] = await Promise.all([
                    fetch(`${API_BASE}/schedules`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    }),
                    fetch(`${API_BASE}/batches`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    }),
                    fetch(`${API_BASE}/semesters`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    })
                ]);
                
                if (schedulesResponse.status === 401 || batchesResponse.status === 401 || semestersResponse.status === 401) {
                    logout();
                    return;
                }
                
                const schedules = await schedulesResponse.json();
                const batches = await batchesResponse.json();
                const semesters = await semestersResponse.json();
                
                console.log('Schedules loaded:', schedules);
                
                const div = document.getElementById('schedulesList');
                if (!div) {
                    console.error('schedulesList div not found!');
                    return;
                }
                
                if (!schedules || schedules.length === 0) {
                    div.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; background: linear-gradient(135deg, #E0F6FF 0%, #B0E0E6 100%); border-radius: 15px; border: 2px dashed #8B0000;">
                            <div style="font-size: 64px; margin-bottom: 20px;">üìÖ</div>
                            <h3 style="color: #8B0000; margin-bottom: 10px;">No Schedules Yet</h3>
                            <p style="color: #666;">Generate your first schedule using the form above!</p>
                        </div>
                    `;
                } else {
                    div.innerHTML = schedules.map(s => {
                        const batchId = s.batchId?._id || s.batchId;
                        const semesterId = s.semesterId?._id || s.semesterId;
                        const batch = batches.find(b => (b._id === batchId) || (b._id === batchId?._id));
                        const semester = semesters.find(sem => (sem._id === semesterId) || (sem._id === semesterId?._id));
                        return `
                            <div style="background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); padding: 25px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); border-left: 5px solid #8B0000; transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 12px 35px rgba(139, 0, 0, 0.2)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.1)';">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                    <div>
                                        <h3 style="margin: 0 0 10px 0; color: #333; font-size: 22px; font-weight: 700;">
                                            üéì Batch ${batch ? batch.batchNumber : 'N/A'} - ${semester ? (semester.name || `Semester ${semester.semesterNumber}`) : 'N/A'} - Section ${s.section}
                                        </h3>
                                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                            <span style="background: ${s.status === 'published' ? '#10b981' : '#f59e0b'}; color: white; padding: 6px 15px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                                ${s.status === 'published' ? '‚úÖ Published' : 'üìù Draft'}
                                            </span>
                                            <span style="background: #8B0000; color: white; padding: 6px 15px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                                üìö ${s.entries?.length || 0} Classes
                                            </span>
                                            ${s.department ? `<span style="background: #8b5cf6; color: white; padding: 6px 15px; border-radius: 20px; font-size: 12px; font-weight: 600;">üèõÔ∏è ${s.department}</span>` : ''}
                                        </div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 10px; margin-top: 20px;">
                                    <button onclick="viewSchedule('${s._id}')" style="flex: 1; background: linear-gradient(135deg, #8B0000 0%, #A52A2A 100%); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                        üëÅÔ∏è View Schedule
                                    </button>
                                    <button onclick="exportPDF('${s._id}')" style="flex: 1; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                        üìÑ Export PDF
                                    </button>
                                    ${s.status === 'draft' ? `<button onclick="publishSchedule('${s._id}')" style="flex: 1; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">‚úÖ Publish</button>` : ''}
                                    <button onclick="deleteSchedule('${s._id}')" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">üóëÔ∏è Delete</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                // Populate dropdowns
                const batchSelect = document.getElementById('scheduleBatchId');
                const semesterSelect = document.getElementById('scheduleSemesterId');
                const sectionSelect = document.getElementById('scheduleSection');
                const departmentSelect = document.getElementById('scheduleDepartment');
                
                if (batchSelect) {
                    // Remove existing listeners
                    const newBatchSelect = batchSelect.cloneNode(true);
                    batchSelect.parentNode.replaceChild(newBatchSelect, batchSelect);
                    
                    newBatchSelect.innerHTML = '<option value="">Select Batch</option>' + batches.map(b => 
                        `<option value="${b._id}">${b.batchNumber}</option>`
                    ).join('');

                    newBatchSelect.addEventListener('change', (e) => {
                        const batchId = e.target.value;
                        if (batchId) {
                            const selectedBatch = batches.find(b => b._id === batchId);
                            
                            // Populate semesters
                            const batchSemesters = semesters.filter(s => {
                                const sBatchId = s.batchId?._id || s.batchId;
                                return sBatchId === batchId;
                            });
                            if (semesterSelect) {
                                semesterSelect.innerHTML = '<option value="">Select Semester</option>' + batchSemesters.map(s => 
                                    `<option value="${s._id}">${s.name || `Semester ${s.semesterNumber}`}</option>`
                                ).join('');
                            }
                            
                            // Populate sections from batch
                            if (sectionSelect && selectedBatch && selectedBatch.sections) {
                                sectionSelect.innerHTML = '<option value="">Select Section</option>' + selectedBatch.sections.map(s => 
                                    `<option value="${s}">${s}</option>`
                                ).join('');
                            }
                            
                            // Load departments from dropdown (already populated by loadDepartmentsForDropdowns)
                            loadDepartmentsForDropdowns();
                        } else {
                            if (semesterSelect) semesterSelect.innerHTML = '<option value="">Select Semester</option>';
                            if (sectionSelect) sectionSelect.innerHTML = '<option value="">Select Section</option>';
                            if (departmentSelect) departmentSelect.innerHTML = '<option value="">Select Department (Optional)</option>';
                        }
                    });
                }
                
                // Load rooms for selection
                loadRoomsForSelection();
            } catch (e) {
                console.error('Error loading schedules:', e);
                const div = document.getElementById('schedulesList');
                if (div) {
                    div.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; background: #fee2e2; border-radius: 15px; border: 2px solid #ef4444;">
                            <div style="font-size: 64px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                            <h3 style="color: #dc2626; margin-bottom: 10px;">Error Loading Schedules</h3>
                            <p style="color: #991b1b;">${e.message || 'Error loading schedules'}</p>
                            <p style="color: #666; margin-top: 10px; font-size: 14px;">Check browser console (F12) for more details.</p>
                        </div>
                    `;
                }
            }
        }
        
        window.loadSchedules = loadSchedules;

        async function viewSchedule(id) {
            try {
                // Get schedule from MongoDB API
                const response = await fetch(`${API_BASE}/schedules/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                if (!response.ok) {
                    alert('Schedule not found');
                    return;
                }
                
                const schedule = await response.json();
                
                // Schedule already has populated batchId and semesterId from API
                const scheduleWithRefs = schedule;
                
                // Create modal for schedule view
                const modal = document.createElement('div');
                modal.id = 'scheduleModal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
                
                const closeModal = () => {
                    modal.remove();
                };
                
                // Render the schedule table
                const scheduleTableHtml = renderScheduleTable(scheduleWithRefs, id);
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 20px; padding: 30px; max-width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); position: relative;">
                        <button id="closeScheduleModal" style="position: absolute; top: 15px; right: 15px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 24px; font-weight: bold; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4); z-index: 10001;" onmouseover="this.style.transform='scale(1.15) rotate(90deg)'; this.style.boxShadow='0 6px 20px rgba(239, 68, 68, 0.6)'" onmouseout="this.style.transform='scale(1) rotate(0deg)'; this.style.boxShadow='0 4px 15px rgba(239, 68, 68, 0.4)'">√ó</button>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 style="margin: 0; color: #8B0000; font-size: 28px;">
                                üìÖ Schedule: Batch ${schedule.batchId?.batchNumber || schedule.batchId || 'N/A'} - ${schedule.semesterId?.name || schedule.semesterId || 'N/A'} - Section ${schedule.section}
                            </h2>
                            <button id="saveScheduleBtn" onclick="saveSchedule('${id}')" style="background: linear-gradient(135deg, #228B22 0%, #32CD32 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">üíæ Save Changes</button>
                        </div>
                        <div id="scheduleEditAlert" style="margin-bottom: 15px;"></div>
                        ${scheduleTableHtml}
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Add close button event listener
                const closeBtn = document.getElementById('closeScheduleModal');
                if (closeBtn) {
                    closeBtn.addEventListener('click', closeModal);
                }
                
                // Close on background click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal();
                    }
                });
                
                // Close on Escape key
                const escapeHandler = (e) => {
                    if (e.key === 'Escape') {
                        closeModal();
                        document.removeEventListener('keydown', escapeHandler);
                    }
                };
                document.addEventListener('keydown', escapeHandler);
            } catch (e) {
                alert('Error loading schedule: ' + e.message);
            }
        }
        
        window.viewSchedule = viewSchedule;

        function renderScheduleTable(schedule, scheduleId) {
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            
            // Load rooms and instructors from localStorage
            const rooms = getRooms();
            const instructors = getInstructors();
            
            let html = '<div style="overflow-x: auto;"><table style="min-width: 1000px; border-collapse: collapse; width: 100%;">';
            html += '<thead><tr><th style="background: linear-gradient(135deg, #8B0000 0%, #A52A2A 100%); color: white; padding: 15px; text-align: center;">Day</th>';
            html += '<th style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 15px; text-align: center;">Morning</th>';
            html += '<th style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 15px; text-align: center;">Afternoon</th></tr></thead><tbody>';
            
            // Create entry index map
            const entryIndexMap = new Map();
            schedule.entries.forEach((entry, idx) => {
                const entryDay = entry.day || entry.dayOfWeek;
                const entryShift = entry.shift || (entry.startTime && parseInt(entry.startTime.split(':')[0]) < 12 ? 'morning' : 'afternoon');
                const key = `${entry.courseCode || entry.courseId}_${entryDay}_${entryShift}_${entry.isLab || false}`;
                if (!entryIndexMap.has(key)) {
                    entryIndexMap.set(key, idx);
                }
            });
            
            days.forEach(day => {
                // Handle both 'day' and 'dayOfWeek' properties, and determine shift from time
                const morningEntries = schedule.entries?.filter(e => {
                    const entryDay = e.day || e.dayOfWeek;
                    const entryShift = e.shift || (e.startTime && parseInt(e.startTime.split(':')[0]) < 12 ? 'morning' : 'afternoon');
                    return entryDay === day && entryShift === 'morning';
                }) || [];
                const afternoonEntries = schedule.entries?.filter(e => {
                    const entryDay = e.day || e.dayOfWeek;
                    const entryShift = e.shift || (e.startTime && parseInt(e.startTime.split(':')[0]) < 12 ? 'morning' : 'afternoon');
                    return entryDay === day && entryShift === 'afternoon';
                }) || [];
                
                html += `<tr>
                    <td style="background: #f8f9fa; font-weight: 700; padding: 15px; text-align: center; border: 2px solid #e5e7eb;">${day}</td>
                    <td style="padding: 15px; vertical-align: top; border: 2px solid #e5e7eb;">
                        ${morningEntries.length > 0 ? morningEntries.map((e, idx) => {
                            const originalIdx = schedule.entries.findIndex(ent => ent === e);
                            return renderEditableEntry(e, originalIdx, 'morning', rooms, instructors, scheduleId, day);
                        }).join('') : `<div style="text-align: center; padding: 20px;">
                            <div style="color: #9ca3af; margin-bottom: 10px;">No classes</div>
                            <button onclick="addManualEntry('${scheduleId}', '${day}', 'morning')" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">‚ûï Add Class</button>
                        </div>`}
                    </td>
                    <td style="padding: 15px; vertical-align: top; border: 2px solid #e5e7eb;">
                        ${afternoonEntries.length > 0 ? afternoonEntries.map((e, idx) => {
                            const originalIdx = schedule.entries.findIndex(ent => ent === e);
                            return renderEditableEntry(e, originalIdx, 'afternoon', rooms, instructors, scheduleId, day);
                        }).join('') : `<div style="text-align: center; padding: 20px;">
                            <div style="color: #9ca3af; margin-bottom: 10px;">No classes</div>
                            <button onclick="addManualEntry('${scheduleId}', '${day}', 'afternoon')" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">‚ûï Add Class</button>
                        </div>`}
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            return html;
        }

        function renderEditableEntry(entry, originalIndex, shift, rooms, instructors, scheduleId, day) {
            const entryId = `entry_${scheduleId}_${originalIndex}`;
            const bgColor = shift === 'morning' ? 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%)' : 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)';
            const borderColor = shift === 'morning' ? '#3b82f6' : '#10b981';
            const textColor = shift === 'morning' ? '#1e40af' : '#065f46';
            
            return `
                <div id="${entryId}" data-entry-index="${originalIndex}" style="background: ${bgColor}; padding: 12px; margin-bottom: 8px; border-radius: 8px; border-left: 4px solid ${borderColor}; position: relative;">
                    <button onclick="deleteEntry('${scheduleId}', ${originalIndex})" style="position: absolute; top: 5px; right: 5px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 16px; font-weight: bold; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);" onmouseover="this.style.transform='scale(1.2) rotate(90deg)'; this.style.boxShadow='0 4px 12px rgba(239, 68, 68, 0.5)'" onmouseout="this.style.transform='scale(1) rotate(0deg)'; this.style.boxShadow='0 2px 8px rgba(239, 68, 68, 0.3)'">√ó</button>
                    <div style="font-weight: 700; color: ${textColor}; font-size: 14px; margin-bottom: 8px;">${entry.courseCode} - ${entry.courseName}</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px; margin-top: 8px;">
                        <div>
                            <label style="font-size: 10px; color: #64748b; display: block; margin-bottom: 4px;">Day</label>
                            <select class="entry-field" data-field="day" data-entry-index="${originalIndex}" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                ${['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].map(d => 
                                    `<option value="${d}" ${d === entry.day ? 'selected' : ''}>${d}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 10px; color: #64748b; display: block; margin-bottom: 4px;">Shift</label>
                            <select class="entry-field" data-field="shift" data-entry-index="${originalIndex}" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                <option value="morning" ${entry.shift === 'morning' ? 'selected' : ''}>Morning</option>
                                <option value="afternoon" ${entry.shift === 'afternoon' ? 'selected' : ''}>Afternoon</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 10px; color: #64748b; display: block; margin-bottom: 4px;">Start Time</label>
                            <input type="time" class="entry-field" data-field="startTime" data-entry-index="${originalIndex}" value="${entry.startTime}" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                        </div>
                        <div>
                            <label style="font-size: 10px; color: #64748b; display: block; margin-bottom: 4px;">End Time</label>
                            <input type="time" class="entry-field" data-field="endTime" data-entry-index="${originalIndex}" value="${entry.endTime}" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                        </div>
                        <div>
                            <label style="font-size: 10px; color: #64748b; display: block; margin-bottom: 4px;">Room</label>
                            <select class="entry-field" data-field="roomId" data-entry-index="${originalIndex}" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                ${rooms.map(r => 
                                    `<option value="${r._id}" data-room-number="${r.roomNumber}" ${r._id === entry.roomId ? 'selected' : ''}>${r.roomNumber} (${r.roomType})</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>
                    <div style="color: #64748b; font-size: 11px; margin-top: 8px;">üë®‚Äçüè´ ${entry.instructorName} ${entry.isLab ? '| üî¨ Lab' : ''}</div>
                </div>
            `;
        }

        async function saveSchedule(scheduleId) {
            try {
                const response = await fetch(`${API_BASE}/schedules/${scheduleId}`);
                const schedule = await response.json();
                
                // Collect all entries from editable fields, grouped by entry index
                const entryFields = document.querySelectorAll('.entry-field');
                const entriesByIndex = {};
                
                entryFields.forEach(field => {
                    const entryIndex = parseInt(field.getAttribute('data-entry-index'));
                    
                    if (!entriesByIndex[entryIndex]) {
                        entriesByIndex[entryIndex] = {};
                    }
                    
                    const fieldName = field.getAttribute('data-field');
                    let value = field.value;
                    
                    if (fieldName === 'roomId') {
                        const selectedOption = field.options[field.selectedIndex];
                        entriesByIndex[entryIndex].roomId = value;
                        entriesByIndex[entryIndex].roomNumber = selectedOption.getAttribute('data-room-number');
                    } else {
                        entriesByIndex[entryIndex][fieldName] = value;
                    }
                });
                
                // Update entries using the index mapping
                const updatedEntries = schedule.entries.map((originalEntry, idx) => {
                    if (entriesByIndex[idx]) {
                        const updates = entriesByIndex[idx];
                        const selectedRoom = document.querySelector(`select[data-entry-index="${idx}"][data-field="roomId"]`);
                        const roomNumber = selectedRoom?.options[selectedRoom.selectedIndex]?.getAttribute('data-room-number') || originalEntry.roomNumber;
                        
                        return {
                            ...originalEntry,
                            day: updates.day || originalEntry.day,
                            shift: updates.shift || originalEntry.shift,
                            startTime: updates.startTime || originalEntry.startTime,
                            endTime: updates.endTime || originalEntry.endTime,
                            roomId: updates.roomId || originalEntry.roomId,
                            roomNumber: roomNumber,
                        };
                    }
                    return originalEntry;
                });
                
                // Update schedule
                const updateResponse = await fetch(`${API_BASE}/schedules/${scheduleId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ entries: updatedEntries })
                });
                
                if (updateResponse.ok) {
                    showAlert('scheduleEditAlert', '‚úÖ Schedule updated successfully!', 'success');
                    setTimeout(() => {
                        document.getElementById('scheduleModal')?.remove();
                        loadSchedules();
                    }, 1500);
                } else {
                    const error = await updateResponse.json();
                    showAlert('scheduleEditAlert', '‚ùå Error: ' + (error.message || 'Failed to update schedule'), 'error');
                }
            } catch (e) {
                showAlert('scheduleEditAlert', '‚ùå Error: ' + e.message, 'error');
            }
        }

        function deleteEntry(scheduleId, entryIndex) {
            if (!confirm('Delete this schedule entry?')) return;
            
            try {
                const storage = getStorageData();
                const schedule = storage.schedules.find(s => s._id === scheduleId);
                
                if (!schedule) {
                    alert('Schedule not found');
                    return;
                }
                
                // Remove entry at index
                schedule.entries = schedule.entries.filter((e, idx) => idx !== entryIndex);
                schedule.updatedAt = new Date().toISOString();
                saveStorageData(storage);
                
                // Reload the schedule view
                viewSchedule(scheduleId);
            } catch (e) {
                alert('Error deleting entry: ' + e.message);
            }
        }
        
        window.deleteEntry = deleteEntry;

        async function addManualEntry(scheduleId, day, shift) {
            try {
                // Load courses, rooms, and instructors
                const [courses, rooms, instructors, schedule] = await Promise.all([
                    fetch(`${API_BASE}/courses`).then(r => r.json()).catch(() => []),
                    fetch(`${API_BASE}/rooms`).then(r => r.json()).catch(() => []),
                    fetch(`${API_BASE}/instructors`).then(r => r.json()).catch(() => []),
                    fetch(`${API_BASE}/schedules/${scheduleId}`).then(r => r.json())
                ]);

                // Create modal for adding new entry
                const modal = document.createElement('div');
                modal.id = 'addEntryModal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10001; display: flex; align-items: center; justify-content: center; padding: 20px;';
                
                const closeModal = () => modal.remove();
                
                const defaultStartTime = shift === 'morning' ? '08:00' : '13:00';
                const defaultEndTime = shift === 'morning' ? '11:00' : '16:00';
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 20px; padding: 30px; max-width: 600px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); position: relative;">
                        <button id="closeAddEntryModal" style="position: absolute; top: 15px; right: 15px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 24px; font-weight: bold; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4); z-index: 10001;" onmouseover="this.style.transform='scale(1.15) rotate(90deg)'; this.style.boxShadow='0 6px 20px rgba(239, 68, 68, 0.6)'" onmouseout="this.style.transform='scale(1) rotate(0deg)'; this.style.boxShadow='0 4px 15px rgba(239, 68, 68, 0.4)'">√ó</button>
                        <h2 style="margin-top: 0; color: #8B0000; font-size: 24px; margin-bottom: 20px;">‚ûï Add Class Manually</h2>
                        <div id="addEntryAlert" style="margin-bottom: 15px;"></div>
                        <form id="addEntryForm" style="display: grid; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Course *</label>
                                <select id="newEntryCourse" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                                    <option value="">Select Course</option>
                                    ${courses.map(c => `<option value="${c._id}" data-code="${c.courseCode}" data-name="${c.courseName}">${c.courseCode} - ${c.courseName}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Instructor *</label>
                                <select id="newEntryInstructor" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                                    <option value="">Select Instructor</option>
                                    ${instructors.map(i => `<option value="${i._id}">${i.fullName}</option>`).join('')}
                                </select>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Start Time *</label>
                                    <input type="time" id="newEntryStartTime" value="${defaultStartTime}" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">End Time *</label>
                                    <input type="time" id="newEntryEndTime" value="${defaultEndTime}" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                                </div>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Room *</label>
                                <select id="newEntryRoom" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
                                    <option value="">Select Room</option>
                                    ${rooms.map(r => `<option value="${r._id}" data-number="${r.roomNumber}">${r.roomNumber} (${r.roomType})</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="newEntryIsLab" style="width: 18px; height: 18px;">
                                    <span style="font-weight: 600; color: #333;">This is a Lab Session</span>
                                </label>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <button type="button" id="cancelAddEntryBtn" style="flex: 1; background: #6b7280; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">Cancel</button>
                                <button type="submit" style="flex: 1; background: linear-gradient(135deg, #8B0000 0%, #A52A2A 100%); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">Add Class</button>
                            </div>
                        </form>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Add event listeners for close buttons
                document.getElementById('closeAddEntryModal').addEventListener('click', closeModal);
                document.getElementById('cancelAddEntryBtn').addEventListener('click', closeModal);
                
                // Close on background click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal();
                });
                
                // Close on Escape key
                const escapeHandler = (e) => {
                    if (e.key === 'Escape') {
                        closeModal();
                        document.removeEventListener('keydown', escapeHandler);
                    }
                };
                document.addEventListener('keydown', escapeHandler);
                
                // Handle form submission
                document.getElementById('addEntryForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const courseSelect = document.getElementById('newEntryCourse');
                    const instructorSelect = document.getElementById('newEntryInstructor');
                    const roomSelect = document.getElementById('newEntryRoom');
                    const startTime = document.getElementById('newEntryStartTime').value;
                    const endTime = document.getElementById('newEntryEndTime').value;
                    const isLab = document.getElementById('newEntryIsLab').checked;
                    
                    const selectedCourse = courses.find(c => c._id === courseSelect.value);
                    const selectedInstructor = instructors.find(i => i._id === instructorSelect.value);
                    const selectedRoom = rooms.find(r => r._id === roomSelect.value);
                    
                    if (!selectedCourse || !selectedInstructor || !selectedRoom) {
                        showAlert('addEntryAlert', '‚ùå Please fill in all required fields', 'error');
                        return;
                    }
                    
                    // Create new entry
                    const newEntry = {
                        courseId: selectedCourse._id,
                        courseCode: selectedCourse.courseCode,
                        courseName: selectedCourse.courseName,
                        instructorId: selectedInstructor._id,
                        instructorName: selectedInstructor.fullName,
                        roomId: selectedRoom._id,
                        roomNumber: selectedRoom.roomNumber,
                        day: day,
                        shift: shift,
                        startTime: startTime,
                        endTime: endTime,
                        isLab: isLab,
                    };
                    
                    // Add to schedule
                    schedule.entries.push(newEntry);
                    
                    const updateResponse = await fetch(`${API_BASE}/schedules/${scheduleId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ entries: schedule.entries })
                    });
                    
                    if (updateResponse.ok) {
                        showAlert('addEntryAlert', '‚úÖ Class added successfully!', 'success');
                        setTimeout(() => {
                            modal.remove();
                            viewSchedule(scheduleId);
                        }, 1000);
                    } else {
                        const error = await updateResponse.json();
                        showAlert('addEntryAlert', '‚ùå Error: ' + (error.message || 'Failed to add class'), 'error');
                    }
                });
            } catch (e) {
                alert('Error loading form: ' + e.message);
            }
        }

        function exportPDF(id) {
            window.open(`/api/export/schedule/${id}/pdf`, '_blank');
        }

        // Rooms
        let editingRoomId = null;
        
        document.getElementById('roomForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                roomNumber: document.getElementById('roomNumber').value,
                roomType: document.getElementById('roomType').value,
                capacity: parseInt(document.getElementById('roomCapacity').value),
                isAvailable: document.getElementById('roomIsAvailable').checked
            };
            
            // Add facilities if provided
            const facilities = document.getElementById('roomFacilities').value;
            if (facilities) {
                data.facilities = facilities.split(',').map(f => f.trim()).filter(f => f);
            }

            try {
                const url = editingRoomId ? `${API_BASE}/rooms/${editingRoomId}` : `${API_BASE}/rooms`;
                const method = editingRoomId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }

                const result = await response.json();
                if (response.ok) {
                    showAlert('roomAlert', editingRoomId ? 'Room updated successfully!' : 'Room created successfully!', 'success');
                    document.getElementById('roomForm').reset();
                    editingRoomId = null;
                    document.getElementById('roomSubmitBtn').textContent = 'Create Room';
                    document.getElementById('roomCancelBtn').style.display = 'none';
                    document.getElementById('roomIsAvailable').checked = true;
                    loadRooms();
                } else {
                    showAlert('roomAlert', result.message || 'Error saving room', 'error');
                }
            } catch (e) {
                showAlert('roomAlert', 'Error: ' + e.message, 'error');
            }
        });

        async function editRoom(id) {
            try {
                const response = await fetch(`${API_BASE}/rooms/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                const room = await response.json();
                
                editingRoomId = id;
                document.getElementById('roomNumber').value = room.roomNumber || '';
                document.getElementById('roomType').value = room.roomType || '';
                document.getElementById('roomCapacity').value = room.capacity || '';
                document.getElementById('roomIsAvailable').checked = room.isAvailable !== false;
                document.getElementById('roomFacilities').value = room.facilities?.join(', ') || '';
                document.getElementById('roomSubmitBtn').textContent = 'Update Room';
                document.getElementById('roomCancelBtn').style.display = 'inline-block';
                
                document.getElementById('roomForm').scrollIntoView({ behavior: 'smooth', block: 'center' });
            } catch (e) {
                alert('Error loading room: ' + e.message);
            }
        }
        
        window.editRoom = editRoom;

        function cancelRoomEdit() {
            editingRoomId = null;
            document.getElementById('roomForm').reset();
            document.getElementById('roomSubmitBtn').textContent = 'Create Room';
            document.getElementById('roomCancelBtn').style.display = 'none';
            document.getElementById('roomIsAvailable').checked = true;
        }

        async function deleteRoom(id) {
            if (!confirm('Delete this room? This action cannot be undone.')) return;
            try {
                const response = await fetch(`${API_BASE}/rooms/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                if (response.ok) {
                    loadRooms();
                    showAlert('roomAlert', '‚úÖ Room deleted successfully!', 'success');
                } else {
                    const result = await response.json();
                    showAlert('roomAlert', '‚ùå ' + (result.message || 'Error deleting room'), 'error');
                }
            } catch (e) {
                showAlert('roomAlert', '‚ùå Error: ' + e.message, 'error');
            }
        }
        
        window.deleteRoom = deleteRoom;

        async function initializeRooms() {
            try {
                const response = await fetch(`${API_BASE}/rooms/initialize`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                const result = await response.json();
                if (response.ok) {
                    showAlert('roomAlert', '‚úÖ Rooms initialized successfully!', 'success');
                    loadRooms();
                } else {
                    showAlert('roomAlert', '‚ùå ' + (result.message || 'Error initializing rooms'), 'error');
                }
            } catch (e) {
                showAlert('roomAlert', '‚ùå Error: ' + e.message, 'error');
            }
        }
        
        window.initializeRooms = initializeRooms;

        async function loadRooms() {
            try {
                const response = await fetch(`${API_BASE}/rooms`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                const rooms = await response.json();
                const tbody = document.querySelector('#roomsTable tbody');
                if (!tbody) return;
                
                if (rooms.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #999;">No rooms found. Create one to get started!</td></tr>';
                    return;
                }
                
                tbody.innerHTML = rooms.map(r => `
                    <tr>
                        <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;">${r.roomNumber}</td>
                        <td style="padding: 15px; border-bottom: 1px solid #e5e7eb; text-transform: capitalize;">${r.roomType}</td>
                        <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;">${r.capacity}</td>
                        <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;">${r.facilities?.join(', ') || 'N/A'}</td>
                        <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;">
                            <span style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; ${r.isAvailable ? 'background: #d1fae5; color: #065f46;' : 'background: #fee2e2; color: #991b1b;'}">
                                ${r.isAvailable ? '‚úì Available' : '‚úó Unavailable'}
                            </span>
                        </td>
                        <td style="padding: 15px; border-bottom: 1px solid #e5e7eb; display: flex; gap: 8px;">
                            <button onclick="editRoom('${r._id}')" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">‚úèÔ∏è Edit</button>
                            <button class="btn-danger" onclick="deleteRoom('${r._id}')" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">üóëÔ∏è Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Error loading rooms:', e);
                const tbody = document.querySelector('#roomsTable tbody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #ef4444;">Error loading rooms: ' + e.message + '</td></tr>';
                }
            }
        }
        
        window.loadRooms = loadRooms;

        window.showAlert = function(id, message, type) {
            const alertDiv = document.getElementById(id);
            if (alertDiv) {
                alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
                setTimeout(() => {
                    alertDiv.innerHTML = '';
                }, 5000);
            }
        };

        // Load rooms for room selection
        async function loadRoomsForSelection() {
            try {
                const response = await fetch(`${API_BASE}/rooms`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                const rooms = await response.json();
                const roomSelectionDiv = document.getElementById('roomSelection');
                if (roomSelectionDiv) {
                    const availableRooms = rooms.filter(r => r.isAvailable !== false);
                    if (availableRooms.length === 0) {
                        roomSelectionDiv.innerHTML = '<p style="color: #999; padding: 20px; text-align: center;">No available rooms. Create rooms first!</p>';
                    } else {
                        roomSelectionDiv.innerHTML = availableRooms.map(r => `
                            <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 6px; cursor: pointer; border: 2px solid #ddd; transition: all 0.3s;" onmouseover="this.style.borderColor='#8B0000'" onmouseout="this.style.borderColor='#ddd'">
                                <input type="checkbox" value="${r._id}" style="width: 18px; height: 18px;">
                                <span style="font-size: 13px; font-weight: 600; color: #333;">${r.roomNumber} (${r.roomType})</span>
                            </label>
                        `).join('');
                    }
                }
            } catch (e) {
                console.error('Error loading rooms for selection:', e);
            }
        }
        
        window.loadRoomsForSelection = loadRoomsForSelection;

        // Load rooms when schedules tab is shown
        document.addEventListener('DOMContentLoaded', () => {
            const schedulesTab = document.querySelector('button[onclick*="schedules"]');
            if (schedulesTab) {
                schedulesTab.addEventListener('click', () => {
                    setTimeout(() => {
                        loadRoomsForSelection();
                    }, 100);
                });
            }
        });

        // Generate All Batches
        document.getElementById('generateAllBatchesBtn')?.addEventListener('click', async function() {
            if (!confirm('Generate schedules for ALL batches? This may take a while.')) return;
            
            const semesterId = document.getElementById('scheduleSemesterId').value;
            if (!semesterId) {
                showAlert('scheduleAlert', '‚ö†Ô∏è Please select a semester first', 'error');
                return;
            }
            
            const originalText = this.innerHTML;
            this.innerHTML = '‚è≥ Generating All Batches...';
            this.disabled = true;
            
            const selectedRoomIds = Array.from(document.querySelectorAll('#roomSelection input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            const prioritySettings = {
                majorCoursesShift: document.getElementById('majorCoursesShift').value,
                commonCoursesShift: document.getElementById('commonCoursesShift').value,
            };
            
            const data = {
                semesterId: semesterId,
                department: document.getElementById('scheduleDepartment').value || undefined,
                selectedRoomIds: selectedRoomIds.length > 0 ? selectedRoomIds : undefined,
                prioritySettings: prioritySettings,
            };
            
            try {
                const response = await fetch(`${API_BASE}/schedules/generate-all`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'Unknown error' }));
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                showAlert('scheduleAlert', `‚úÖ Generated ${result.schedules?.length || 0} schedules successfully!`, 'success');
                
                if (result.totalConflicts?.length > 0 || result.totalWarnings?.length > 0) {
                    let message = '';
                    if (result.totalConflicts?.length > 0) {
                        message += `‚ö†Ô∏è ${result.totalConflicts.length} conflicts detected. `;
                    }
                    if (result.totalWarnings?.length > 0) {
                        message += `‚ÑπÔ∏è ${result.totalWarnings.length} warnings. `;
                    }
                    showAlert('scheduleAlert', message, 'error');
                }
                
                await loadSchedules();
                
                this.innerHTML = '‚úÖ All Generated!';
                setTimeout(() => {
                    this.innerHTML = originalText;
                    this.disabled = false;
                }, 2000);
            } catch (e) {
                console.error('Generate all batches error:', e);
                showAlert('scheduleAlert', '‚ùå Error: ' + (e.message || 'Failed to generate schedules'), 'error');
                this.innerHTML = originalText;
                this.disabled = false;
            }
        });

        // Class Representatives
        let editingClassRepId = null;
        
        document.getElementById('classRepForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                batchId: document.getElementById('classRepBatchId').value,
                section: document.getElementById('classRepSection').value,
                fullName: document.getElementById('classRepFullName').value,
                idNumber: document.getElementById('classRepIdNumber').value,
                phoneNumber: document.getElementById('classRepPhone').value || undefined,
                email: document.getElementById('classRepEmail').value || undefined,
            };
            
            try {
                const url = editingClassRepId ? `${API_BASE}/class-representatives/${editingClassRepId}` : `${API_BASE}/class-representatives`;
                const method = editingClassRepId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                const result = await response.json();
                if (response.ok) {
                    showAlert('classRepAlert', '‚úÖ ' + (editingClassRepId ? 'Class representative updated' : 'Class representative created') + ' successfully!', 'success');
                    document.getElementById('classRepForm').reset();
                    editingClassRepId = null;
                    document.getElementById('classRepSubmitBtn').textContent = 'Create Class Representative';
                    document.getElementById('classRepCancelBtn').style.display = 'none';
                    loadClassRepresentatives();
                } else {
                    showAlert('classRepAlert', '‚ùå ' + (result.message || 'Error saving class representative'), 'error');
                }
            } catch (e) {
                showAlert('classRepAlert', 'Error: ' + e.message, 'error');
            }
        });
        
        async function loadClassRepresentatives() {
            try {
                const [repsResponse, batchesResponse] = await Promise.all([
                    fetch(`${API_BASE}/class-representatives`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    }),
                    fetch(`${API_BASE}/batches`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    })
                ]);
                
                if (repsResponse.status === 401 || batchesResponse.status === 401) {
                    logout();
                    return;
                }
                
                const reps = await repsResponse.json();
                const batches = await batchesResponse.json();
                const tbody = document.querySelector('#classRepTable tbody');
                if (!tbody) return;
                
                if (reps.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">No class representatives found. Create one to get started!</td></tr>';
                } else {
                    tbody.innerHTML = reps.map(r => {
                        const batchId = r.batchId?._id || r.batchId;
                        const batch = batches.find(b => (b._id === batchId) || (b._id === batchId?._id));
                        return `
                        <tr>
                            <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;">${batch ? batch.batchNumber : 'N/A'}</td>
                            <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;">${r.section}</td>
                            <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;">${r.fullName}</td>
                            <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;">${r.idNumber}</td>
                            <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;">${r.phoneNumber || 'N/A'}</td>
                            <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;">${r.email || 'N/A'}</td>
                            <td style="padding: 15px; border-bottom: 1px solid #e5e7eb; display: flex; gap: 8px;">
                                <button onclick="editClassRep('${r._id}')" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">‚úèÔ∏è Edit</button>
                                <button class="btn-danger" onclick="deleteClassRepresentative('${r._id}')" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">üóëÔ∏è Delete</button>
                            </td>
                        </tr>
                        `;
                    }).join('');
                }
                
                // Populate batch dropdown
                const batchSelect = document.getElementById('classRepBatchId');
                if (batchSelect) {
                    // Remove existing listeners
                    const newBatchSelect = batchSelect.cloneNode(true);
                    batchSelect.parentNode.replaceChild(newBatchSelect, batchSelect);
                    
                    newBatchSelect.innerHTML = '<option value="">Select Batch</option>' + batches.map(b => 
                        `<option value="${b._id}">${b.batchNumber}</option>`
                    ).join('');
                    
                    // Update section dropdown when batch changes
                    newBatchSelect.addEventListener('change', async (e) => {
                        const batchId = e.target.value;
                        const sectionSelect = document.getElementById('classRepSection');
                        if (batchId) {
                            const selectedBatch = batches.find(b => b._id === batchId);
                            if (selectedBatch && selectedBatch.sections) {
                                sectionSelect.innerHTML = '<option value="">Select Section</option>' + selectedBatch.sections.map(s => 
                                    `<option value="${s}">${s}</option>`
                                ).join('');
                            }
                        } else {
                            sectionSelect.innerHTML = '<option value="">Select Section</option>';
                        }
                    });
                }
            } catch (e) {
                console.error('Error loading class representatives:', e);
                const tbody = document.querySelector('#classRepTable tbody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #ef4444;">Error loading class representatives: ' + e.message + '</td></tr>';
                }
            }
        }
        
        window.loadClassRepresentatives = loadClassRepresentatives;
        
        async function editClassRep(id) {
            try {
                const [repResponse, batchesResponse] = await Promise.all([
                    fetch(`${API_BASE}/class-representatives/${id}`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    }),
                    fetch(`${API_BASE}/batches`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    })
                ]);
                
                if (repResponse.status === 401 || batchesResponse.status === 401) {
                    logout();
                    return;
                }
                
                const rep = await repResponse.json();
                const batches = await batchesResponse.json();
                
                editingClassRepId = id;
                const batchId = rep.batchId?._id || rep.batchId;
                document.getElementById('classRepBatchId').value = batchId;
                document.getElementById('classRepSection').value = rep.section || '';
                document.getElementById('classRepFullName').value = rep.fullName || '';
                document.getElementById('classRepIdNumber').value = rep.idNumber || '';
                document.getElementById('classRepPhone').value = rep.phoneNumber || '';
                document.getElementById('classRepEmail').value = rep.email || '';
                document.getElementById('classRepSubmitBtn').textContent = 'Update Class Representative';
                document.getElementById('classRepCancelBtn').style.display = 'inline-block';
                
                // Load batches and sections
                const batchSelect = document.getElementById('classRepBatchId');
                batchSelect.innerHTML = '<option value="">Select Batch</option>' + batches.map(b => 
                    `<option value="${b._id}" ${b._id === batchId ? 'selected' : ''}>${b.batchNumber}</option>`
                ).join('');
                
                const selectedBatch = batches.find(b => b._id === batchId);
                if (selectedBatch && selectedBatch.sections) {
                    const sectionSelect = document.getElementById('classRepSection');
                    sectionSelect.innerHTML = '<option value="">Select Section</option>' + selectedBatch.sections.map(s => 
                        `<option value="${s}" ${s === rep.section ? 'selected' : ''}>${s}</option>`
                    ).join('');
                }
                
                document.getElementById('classRepForm').scrollIntoView({ behavior: 'smooth', block: 'center' });
            } catch (e) {
                alert('Error loading class representative: ' + e.message);
            }
        }
        
        window.editClassRep = editClassRep;
        
        function cancelClassRepEdit() {
            editingClassRepId = null;
            document.getElementById('classRepForm').reset();
            document.getElementById('classRepSubmitBtn').textContent = 'Create Class Representative';
            document.getElementById('classRepCancelBtn').style.display = 'none';
        }
        
        function deleteClassRep(id) {
            deleteClassRepresentative(id);
        }
        
        window.deleteClassRep = deleteClassRep;

        // Departments - localStorage version
        let editingDepartmentId = null;
        
        // Make sure form exists before adding listener
        const departmentForm = document.getElementById('departmentForm');
        if (departmentForm) {
            departmentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('departmentName').value.trim(),
                code: document.getElementById('departmentCode').value.trim().toUpperCase(),
            };
            
            if (!data.name || !data.code) {
                showAlert('departmentAlert', 'Department name and code are required!', 'error');
                return;
            }
            
            try {
                const url = editingDepartmentId ? `${API_BASE}/departments/${editingDepartmentId}` : `${API_BASE}/departments`;
                const method = editingDepartmentId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('departmentAlert', '‚úÖ ' + (editingDepartmentId ? 'Department updated' : 'Department created') + ' successfully!', 'success');
                    document.getElementById('departmentForm').reset();
                    editingDepartmentId = null;
                    document.getElementById('departmentSubmitBtn').textContent = 'Create Department';
                    document.getElementById('departmentCancelBtn').style.display = 'none';
                    loadDepartments();
                    // Refresh all department dropdowns
                    setTimeout(() => {
                        loadDepartmentsForDropdowns();
                        console.log('‚úÖ Department saved - refreshing all dropdowns');
                    }, 200);
                } else {
                    showAlert('departmentAlert', '‚ùå ' + (result.message || 'Error saving department'), 'error');
                }
            } catch (e) {
                showAlert('departmentAlert', '‚ùå Error: ' + e.message, 'error');
            }
            });
        }
        
        window.loadDepartments = async function() {
            try {
                const response = await fetch(`${API_BASE}/departments`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                const departments = await response.json();
                const tbody = document.querySelector('#departmentsTable tbody');
                if (!tbody) return;
                
                if (departments.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 40px; color: #999;">No departments found. Create one to get started!</td></tr>';
                    return;
                }
                
                departments.sort((a, b) => a.name.localeCompare(b.name));
                
                tbody.innerHTML = departments.map(dept => `
                    <tr>
                        <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;"><strong>${dept.name}</strong></td>
                        <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;"><strong style="color: #8B0000;">${dept.code}</strong></td>
                        <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;">
                            <button onclick="editDepartment('${dept._id}')" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; margin-right: 5px;">‚úèÔ∏è Edit</button>
                            <button onclick="deleteDepartment('${dept._id}')" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">üóëÔ∏è Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Error loading departments:', e);
                const tbody = document.querySelector('#departmentsTable tbody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 40px; color: #ef4444;">Error loading departments: ' + e.message + '</td></tr>';
                }
            }
        };
        
        async function loadDepartmentsForDropdowns() {
            try {
                const response = await fetch(`${API_BASE}/departments`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                const departments = await response.json();
                departments.sort((a, b) => a.name.localeCompare(b.name));
                
                console.log('Loading departments for dropdowns:', departments.length, 'departments found');
                
                // Update course department dropdown
                const courseDeptSelect = document.getElementById('courseDepartment');
                if (courseDeptSelect) {
                    const currentValue = courseDeptSelect.value;
                    if (departments.length > 0) {
                        courseDeptSelect.innerHTML = '<option value="">Select Department (Optional)</option>' + 
                            departments.map(d => 
                                `<option value="${d.name}">${d.name} (${d.code})</option>`
                            ).join('');
                    } else {
                        courseDeptSelect.innerHTML = '<option value="">No departments available</option>';
                    }
                    courseDeptSelect.value = currentValue;
                }
                
                // Update schedule department dropdown
                const scheduleDeptSelect = document.getElementById('scheduleDepartment');
                if (scheduleDeptSelect) {
                    const currentValue = scheduleDeptSelect.value;
                    if (departments.length > 0) {
                        scheduleDeptSelect.innerHTML = '<option value="">Select Department (Optional)</option>' + 
                            departments.map(d => 
                                `<option value="${d.name}">${d.name} (${d.code})</option>`
                            ).join('');
                    } else {
                        scheduleDeptSelect.innerHTML = '<option value="">No departments available</option>';
                    }
                    scheduleDeptSelect.value = currentValue;
                }
            } catch (e) {
                console.error('Error loading departments for dropdowns:', e);
            }
        }
        
        window.loadDepartmentsForDropdowns = loadDepartmentsForDropdowns;
        
        window.editDepartment = async function(id) {
            try {
                const response = await fetch(`${API_BASE}/departments/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                const dept = await response.json();
                if (!dept) {
                    alert('Department not found');
                    return;
                }
                
                editingDepartmentId = id;
                document.getElementById('departmentName').value = dept.name || '';
                document.getElementById('departmentCode').value = dept.code || '';
                document.getElementById('departmentSubmitBtn').textContent = 'Update Department';
                document.getElementById('departmentCancelBtn').style.display = 'inline-block';
                
                document.getElementById('departmentForm').scrollIntoView({ behavior: 'smooth', block: 'center' });
            } catch (e) {
                alert('Error loading department: ' + e.message);
            }
        };
        
        window.cancelDepartmentEdit = function() {
            editingDepartmentId = null;
            document.getElementById('departmentForm').reset();
            document.getElementById('departmentSubmitBtn').textContent = 'Create Department';
            document.getElementById('departmentCancelBtn').style.display = 'none';
        };
        
        window.deleteDepartment = async function(id) {
            if (!confirm('Delete this department? This will remove it from all dropdowns.')) return;
            try {
                const response = await fetch(`${API_BASE}/departments/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                if (response.ok) {
                    loadDepartments();
                    // Refresh all department dropdowns
                    setTimeout(() => {
                        loadDepartmentsForDropdowns();
                        console.log('Department deleted - refreshing all dropdowns');
                    }, 150);
                    showAlert('departmentAlert', '‚úÖ Department deleted successfully!', 'success');
                } else {
                    const result = await response.json();
                    showAlert('departmentAlert', '‚ùå ' + (result.message || 'Error deleting department'), 'error');
                }
            } catch (e) {
                alert('Error deleting department: ' + e.message);
            }
        };
        
        // ========== USER MANAGEMENT FUNCTIONS ==========
        let editingUserId = null;
        
        async function loadUsers() {
            if (currentUser?.role !== 'admin') {
                showAlert('userAlert', '‚ùå Only admins can access user management', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/users`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                const users = await response.json();
                const tbody = document.querySelector('#usersTable tbody');
                if (!tbody) return;
                
                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #999;">No users found.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = users.map(u => `
                    <tr>
                        <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;">${u.fullName || 'N/A'}</td>
                        <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;">${u.email || 'N/A'}</td>
                        <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;"><span style="background: ${u.role === 'admin' ? '#ef4444' : u.role === 'instructor' ? '#3b82f6' : '#10b981'}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; text-transform: capitalize;">${u.role || 'N/A'}</span></td>
                        <td style="padding: 15px; border-bottom: 1px solid #e5e7eb;">${u.phoneNumber || 'N/A'}</td>
                        <td style="padding: 15px; border-bottom: 1px solid #e5e7eb; display: flex; gap: 8px;">
                            <button onclick="editUser('${u._id}')" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">‚úèÔ∏è Edit</button>
                            ${u._id !== currentUser?.id ? `<button onclick="deleteUser('${u._id}')" class="btn-danger" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">üóëÔ∏è Delete</button>` : '<span style="color: #999; font-size: 12px;">Current User</span>'}
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                showAlert('userAlert', '‚ùå Error loading users: ' + e.message, 'error');
            }
        }
        
        window.loadUsers = loadUsers;
        
        async function editUser(id) {
            try {
                const response = await fetch(`${API_BASE}/users/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                const user = await response.json();
                editingUserId = id;
                document.getElementById('userEditId').value = id;
                document.getElementById('userFullName').value = user.fullName;
                document.getElementById('userEmailInput').value = user.email;
                document.getElementById('userPassword').value = '';
                document.getElementById('userRole').value = user.role;
                document.getElementById('userPhoneNumber').value = user.phoneNumber || '';
                document.getElementById('userSubmitBtn').textContent = 'Update User';
                document.getElementById('userCancelBtn').style.display = 'inline-block';
                document.getElementById('userPasswordLabel').textContent = '(leave blank to keep current)';
                document.getElementById('userPassword').required = false;
                
                // Non-admins can't change role
                if (currentUser.role !== 'admin') {
                    document.getElementById('userRole').disabled = true;
                }
            } catch (e) {
                showAlert('userAlert', '‚ùå Error loading user: ' + e.message, 'error');
            }
        }
        
        window.editUser = editUser;
        
        function cancelUserEdit() {
            editingUserId = null;
            document.getElementById('userForm').reset();
            document.getElementById('userEditId').value = '';
            document.getElementById('userSubmitBtn').textContent = 'Create User';
            document.getElementById('userCancelBtn').style.display = 'none';
            document.getElementById('userPasswordLabel').textContent = '*';
            document.getElementById('userPassword').required = true;
            document.getElementById('userRole').disabled = false;
        }
        
        window.cancelUserEdit = cancelUserEdit;
        
        async function deleteUser(id) {
            if (!confirm('Delete this user? This action cannot be undone.')) return;
            
            try {
                const response = await fetch(`${API_BASE}/users/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    logout();
                    return;
                }
                
                if (response.ok) {
                    loadUsers();
                    showAlert('userAlert', '‚úÖ User deleted successfully!', 'success');
                } else {
                    const data = await response.json();
                    showAlert('userAlert', '‚ùå ' + (data.message || 'Error deleting user'), 'error');
                }
            } catch (e) {
                showAlert('userAlert', '‚ùå Error: ' + e.message, 'error');
            }
        }
        
        window.deleteUser = deleteUser;
        
        // User form submission
        const userForm = document.getElementById('userForm');
        if (!userForm) {
            console.error('User form not found!');
        } else {
            userForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('User form submitted!');
                
                const submitBtn = document.getElementById('userSubmitBtn');
                if (!submitBtn) {
                    console.error('Submit button not found!');
                    return;
                }
                const originalBtnText = submitBtn.textContent;
                
                if (currentUser?.role !== 'admin') {
                    showAlert('userAlert', '‚ùå Only admins can manage users', 'error');
                    return;
                }
            
            // Disable button and show loading state
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';
            
            try {
                // Get form elements
                const fullNameEl = document.getElementById('userFullName');
                const emailEl = document.getElementById('userEmailInput');
                const roleEl = document.getElementById('userRole');
                const passwordEl = document.getElementById('userPassword');
                const phoneNumberEl = document.getElementById('userPhoneNumber');
                
                // Check if all required elements exist
                if (!fullNameEl || !emailEl || !roleEl || !passwordEl) {
                    console.error('Form elements not found:', {
                        fullName: !!fullNameEl,
                        email: !!emailEl,
                        role: !!roleEl,
                        password: !!passwordEl
                    });
                    showAlert('userAlert', '‚ùå Form elements not found. Please refresh the page.', 'error');
                    return;
                }
                
                // Get and trim form values safely
                const fullName = fullNameEl.value ? fullNameEl.value.trim() : '';
                const email = emailEl.value ? emailEl.value.trim() : '';
                const role = roleEl.value ? roleEl.value.trim() : '';
                const password = passwordEl.value ? passwordEl.value.trim() : '';
                const phoneNumber = phoneNumberEl && phoneNumberEl.value ? phoneNumberEl.value.trim() : '';
                
                // Debug logging
                console.log('Form values:', { fullName, email, role, passwordLength: password.length, editingUserId });
            
                // Validate required fields
                if (!fullName) {
                    showAlert('userAlert', '‚ùå Full Name is required', 'error');
                    return;
                }
                if (!email) {
                    showAlert('userAlert', '‚ùå Email is required', 'error');
                    return;
                }
                if (!role) {
                    showAlert('userAlert', '‚ùå Role is required', 'error');
                    return;
                }
                if (!editingUserId && !password) {
                    showAlert('userAlert', '‚ùå Password is required', 'error');
                    return;
                }
                if (password && password.length < 6) {
                    showAlert('userAlert', '‚ùå Password must be at least 6 characters', 'error');
                    return;
                }
            
                const data = {
                    fullName: fullName,
                    email: email,
                    role: role,
                    phoneNumber: phoneNumber || undefined
                };
                
                // Include password if provided (required for new users, optional for updates)
                if (password) {
                    data.password = password;
                }
                const url = editingUserId ? `${API_BASE}/users/${editingUserId}` : `${API_BASE}/users`;
                const method = editingUserId ? 'PUT' : 'POST';
                
                console.log('Submitting user form:', { url, method, data });
                
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });
                
                console.log('Response status:', response.status);
                
                if (response.status === 401) {
                    showAlert('userAlert', '‚ùå Authentication failed. Please login again.', 'error');
                    logout();
                    return;
                }
                
                let result;
                try {
                    result = await response.json();
                } catch (jsonError) {
                    const text = await response.text();
                    console.error('Failed to parse JSON response:', text);
                    showAlert('userAlert', '‚ùå Server error: ' + text, 'error');
                    return;
                }
                
                console.log('Response data:', result);
                
                if (response.ok) {
                    showAlert('userAlert', '‚úÖ ' + (editingUserId ? 'User updated' : 'User created') + ' successfully!', 'success');
                    cancelUserEdit();
                    loadUsers();
                } else {
                    showAlert('userAlert', '‚ùå ' + (result.message || 'Error saving user'), 'error');
                }
            } catch (e) {
                console.error('Form submission error:', e);
                showAlert('userAlert', '‚ùå Error: ' + (e.message || 'Failed to submit form. Please check your connection.'), 'error');
            } finally {
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
            }
            });
        }
        
        // Initialize page on load
        function initializeApp() {
            console.log('Initializing app...');
            console.log('Auth token:', authToken ? 'Present' : 'Missing');
            console.log('Current user:', currentUser);
            
            if (checkAuth()) {
                console.log('User authenticated, showing admin panel');
                showAdminPanel();
                loadDashboard();
                
                // Show Users tab only for admins
                if (currentUser?.role === 'admin') {
                    const usersTab = document.getElementById('usersTab');
                    if (usersTab) usersTab.style.display = 'inline-block';
                }
            } else {
                console.log('User not authenticated, showing login page');
                showLoginPage();
            }
        }
        
        // Run initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html>

